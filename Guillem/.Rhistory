AUC = sum(diff(year) * (head(.data[[outcome]], -1) + tail(.data[[outcome]], -1)) / 2, na.rm = TRUE)
)
summary(summary_stats)
#AUC: Area Under the Curve
model_auc <- lm(AUC ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_auc)
cat("The most significant ones are: sex, edu, inkomen, job, adl, wzc, abpet_base and taupet_base (***)")
#Endpoints
model_endpoint <- lm(yini ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_endpoint)
cat("The most significant ones are: age, HigherEdu, inkomen, job, adl, wzc, abpet and cdrsb(***)")
#Endpoints (Depending also on the bprs baseline) Linear Regression including bprs as a predictor
model_ancova <- lm(yini ~ y0 + trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_ancova)
cat("The most significant ones are: inkomen, job, adl, wzc, abpet, cdrsb_base(***)")
#Increment
model_increment <- lm(increment ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_increment)
library(ggplot2)
library(gridExtra)
# Define the outcome variable
outcome <- "bprs"
# Compute summary statistics: AUC, endpoint, increment
summary_stats <- alz_long %>%
group_by(patid) %>%
summarise(
trial = first(trial),
sex = first(sex),
age = first(age),
edu = first(edu),
bmi = first(bmi),
inkomen = first(inkomen),
job = first(job),
adl = first(adl),
wzc = first(wzc),
abpet_base = first(abpet_base),
taupet_base = first(taupet_base),
cdrsb_base = first(cdrsb_base),
# Baseline Value
y0 = first(.data[[outcome]]),
# Last Available Measurement
yini = last(na.omit(.data[[outcome]])),
# Last Time Point Observed
tmax = last(na.omit(year)),
# Increment
increment = yini - y0,
# Area Under the Curve (AUC) using trapezoidal rule
AUC = sum(diff(year) * (head(.data[[outcome]], -1) + tail(.data[[outcome]], -1)) / 2, na.rm = TRUE)
)
summary(summary_stats)
#AUC: Area Under the Curve
model_auc <- lm(AUC ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_auc)
cat("The most significant ones are: sex, edu, inkomen, job, adl, wzc, abpet_base and taupet_base (***)")
#Endpoints
model_endpoint <- lm(yini ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_endpoint)
cat("The most significant ones are: age, HigherEdu, inkomen, job, adl, wzc, abpet_base and cdrsb_base(***)")
#Endpoints (Depending also on the bprs baseline) Linear Regression including bprs as a predictor
model_ancova <- lm(yini ~ y0 + trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_ancova)
cat("The most significant ones are: inkomen, job, adl, wzc, abpet_base and cdrsb_base(***) [y0 highly significant (**)]")
#Increment
model_increment <- lm(increment ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_increment)
cat("The most significant ones are: inkomen, job, adl, wzc, abpet_base and cdrsb_base(***)")
AIC(model_auc, model_endpoint, model_increment, model_ancova)
BIC(model_auc, model_endpoint, model_increment, model_ancova)
# Create predicted vs observed plots for all models
p1 <- ggplot(summary_stats, aes(x = AUC, y = fitted(model_auc))) +
geom_point(alpha = 0.6) +
geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
labs(title = "Predicted vs Observed: AUC",
x = "Observed AUC",
y = "Predicted AUC") +
theme_minimal()
p2 <- ggplot(summary_stats, aes(x = yini, y = fitted(model_endpoint))) +
geom_point(alpha = 0.6) +
geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
labs(title = "Predicted vs Observed: Endpoint",
x = "Observed Endpoint",
y = "Predicted Endpoint") +
theme_minimal()
p3 <- ggplot(summary_stats, aes(x = yini, y = fitted(model_ancova))) +
geom_point(alpha = 0.6) +
geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
labs(title = "Predicted vs Observed: Endpoint (ANCOVA)",
x = "Observed Endpoint",
y = "Predicted Endpoint") +
theme_minimal()
p4 <- ggplot(summary_stats, aes(x = increment, y = fitted(model_increment))) +
geom_point(alpha = 0.6) +
geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
labs(title = "Predicted vs Observed: Increment",
x = "Observed Increment",
y = "Predicted Increment") +
theme_minimal()
grid.arrange(p1, p2, p3, p4, ncol = 2)
# Residuals vs Fitted plots for all models
par(mfrow = c(2, 2))
plot(fitted(model_auc), residuals(model_auc),
main = "Residuals vs Fitted: AUC",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
plot(fitted(model_endpoint), residuals(model_endpoint),
main = "Residuals vs Fitted: Endpoint",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
plot(fitted(model_ancova), residuals(model_ancova),
main = "Residuals vs Fitted: Endpoint (ANCOVA)",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
plot(fitted(model_increment), residuals(model_increment),
main = "Residuals vs Fitted: Increment",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
grid.arrange(p1, p2, p3, p4, ncol = 2)
AIC(model_auc, model_endpoint, model_increment, model_ancova)
BIC(model_auc, model_endpoint, model_increment, model_ancova)
# Load packages
library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
# Stage 1: Subject-specific linear regressions
fit_subject_lm <- function(df) {
lm(bprs ~ year, data = df)
}
# Fit models for each patient
subject_models <- alz_long %>%
group_by(patid) %>%
group_map(~fit_subject_lm(.x), .keep = TRUE)
# Extract coefficients for each subject
subject_coefs <- map_dfr(subject_models, coef) %>%
mutate(patid = alz_long %>% group_by(patid) %>% group_keys() %>% pull(patid))
head(subject_coefs)
# Merge baseline covariates
subject_data <- alz_long %>%
select(patid, sex, age, edu, bmi, job, adl, wzc, abpet_base, taupet_base, cdrsb_base) %>%
distinct() %>%
left_join(subject_coefs, by = "patid")
# Intercept model
intercept_model <- lm(`(Intercept)` ~ sex + age + edu + bmi + job + adl + wzc +
abpet_base + taupet_base + cdrsb_base,
data = subject_data)
summary(intercept_model)
# Slope model
slope_model <- lm(year ~ sex + age + edu + bmi + job + adl + wzc +
abpet_base + taupet_base + cdrsb_base,
data = subject_data %>%
rename(year = `year`))  # Ensure slope column named "year"
summary(slope_model)
# Optional: Plot Stage 1 fits for visualization
ggplot(alz_long, aes(x = year, y = bprs, group = patid)) +
geom_point(alpha = 0.5) +
geom_line(data = subject_data %>%
rowwise() %>%
mutate(years = list(0:4)) %>%
unnest(cols = c(years)) %>%
mutate(bprs_pred = `(Intercept)` + year * years),
aes(x = years, y = bprs_pred, group = patid),
color = "red", alpha = 0.5) +
labs(title = "Stage 1: Subject-specific linear regressions for BPRS") +
theme_minimal()
# Stage 1: Subject-specific linear regressions
fit_subject_lm <- function(df) {
lm(bprs ~ year, data = df)
}
# Load packages
library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
# Stage 1: Subject-specific linear regressions (no placeholder function)
subject_models <- alz_long %>%
group_by(patid) %>%
group_map(~ lm(bprs ~ year, data = .x), .keep = TRUE)
# Extract coefficients for each subject
subject_coefs <- map_dfr(subject_models, coef) %>%
mutate(patid = alz_long %>% group_by(patid) %>% group_keys() %>% pull(patid))
head(subject_coefs)
# Merge baseline covariates
subject_data <- alz_long %>%
select(patid, sex, age, edu, bmi, job, adl, wzc, abpet_base, taupet_base, cdrsb_base) %>%
distinct() %>%
left_join(subject_coefs, by = "patid")
# Intercept model
intercept_model <- lm(`(Intercept)` ~ sex + age + edu + bmi + job + adl + wzc +
abpet_base + taupet_base + cdrsb_base,
data = subject_data)
summary(intercept_model)
# Slope model
slope_model <- lm(year ~ sex + age + edu + bmi + job + adl + wzc +
abpet_base + taupet_base + cdrsb_base,
data = subject_data %>%
rename(year = `year`))  # Ensure slope column named "year"
summary(slope_model)
# Optional: Plot Stage 1 fits for visualization
ggplot(alz_long, aes(x = year, y = bprs, group = patid)) +
geom_point(alpha = 0.5) +
geom_line(data = subject_data %>%
rowwise() %>%
mutate(years = list(0:4)) %>%
unnest(cols = c(years)) %>%
mutate(bprs_pred = `(Intercept)` + year * years),
aes(x = years, y = bprs_pred, group = patid),
color = "red", alpha = 0.5) +
labs(title = "Stage 1: Subject-specific linear regressions for BPRS") +
theme_minimal()
head(subject_coefs)
# Load packages
library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
# Stage 1: Subject-specific linear regressions (no placeholder function)
subject_models <- alz_long %>%
group_by(patid) %>%
group_map(~ lm(bprs ~ year, data = .x), .keep = TRUE)
# Extract coefficients for each subject
subject_coefs <- map_dfr(subject_models, coef) %>%
mutate(patid = alz_long %>% group_by(patid) %>% group_keys() %>% pull(patid))
head(subject_coefs)
# Merge baseline covariates
subject_data <- alz_long %>%
select(patid, trial, sex, age, edu, bmi, inkomen, job, adl, wzc, abpet_base, taupet_base, cdrsb_base) %>%
distinct() %>%
left_join(subject_coefs, by = "patid")
# Intercept model
intercept_model <- lm(`(Intercept)` ~ sex + age + edu + bmi + job + adl + wzc +
abpet_base + taupet_base + cdrsb_base,
data = subject_data)
summary(intercept_model)
# Slope model
slope_model <- lm(year ~ sex + age + edu + bmi + job + adl + wzc +
abpet_base + taupet_base + cdrsb_base,
data = subject_data %>%
rename(year = `year`))  # Ensure slope column named "year"
summary(slope_model)
# Optional: Plot Stage 1 fits for visualization
ggplot(alz_long, aes(x = year, y = bprs, group = patid)) +
geom_point(alpha = 0.5) +
geom_line(data = subject_data %>%
rowwise() %>%
mutate(years = list(0:4)) %>%
unnest(cols = c(years)) %>%
mutate(bprs_pred = `(Intercept)` + year * years),
aes(x = years, y = bprs_pred, group = patid),
color = "red", alpha = 0.5) +
labs(title = "Stage 1: Subject-specific linear regressions for BPRS") +
theme_minimal()
# Load packages
library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
# Stage 1: Subject-specific linear regressions (no placeholder function)
subject_models <- alz_long %>%
group_by(patid) %>%
group_map(~ lm(bprs ~ year, data = .x), .keep = TRUE)
# Extract coefficients for each subject
subject_coefs <- map_dfr(subject_models, coef) %>%
mutate(patid = alz_long %>% group_by(patid) %>% group_keys() %>% pull(patid))
head(subject_coefs)
# Merge baseline covariates
subject_data <- alz_long %>%
select(patid, trial, sex, age, edu, bmi, inkomen, job, adl, wzc, abpet_base, taupet_base, cdrsb_base) %>%
distinct() %>%
left_join(subject_coefs, by = "patid")
# Intercept model
intercept_model <- lm(`(Intercept)` ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc +
abpet_base + taupet_base + cdrsb_base,
data = subject_data)
summary(intercept_model)
# Slope model
slope_model <- lm(year ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc +
abpet_base + taupet_base + cdrsb_base,
data = subject_data %>%
rename(year = `year`))  # Ensure slope column named "year"
summary(slope_model)
# Optional: Plot Stage 1 fits for visualization
ggplot(alz_long, aes(x = year, y = bprs, group = patid)) +
geom_point(alpha = 0.5) +
geom_line(data = subject_data %>%
rowwise() %>%
mutate(years = list(0:4)) %>%
unnest(cols = c(years)) %>%
mutate(bprs_pred = `(Intercept)` + year * years),
aes(x = years, y = bprs_pred, group = patid),
color = "red", alpha = 0.5) +
labs(title = "Stage 1: Subject-specific linear regressions for BPRS") +
theme_minimal()
# Load packages
library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
# Stage 1: Subject-specific linear regressions (no placeholder function)
stage1_models <- alz_long %>%
group_by(patid) %>%
group_map(~ lm(bprs ~ year, data = .x), .keep = TRUE)
# Extract coefficients for each subject
beta_coefs <- map_dfr(stage1_models, coef) %>%
mutate(patid = alz_long %>% group_by(patid) %>% group_keys() %>% pull(patid))
head(beta_coefs)
# Merge baseline covariates
subject_data <- alz_long %>%
select(patid, trial, sex, age, edu, bmi, inkomen, job, adl, wzc, abpet_base, taupet_base, cdrsb_base) %>%
distinct() %>%
left_join(beta_coefs, by = "patid")
# Intercept model
stage2_intercept_model <- lm(`(Intercept)` ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc +
abpet_base + taupet_base + cdrsb_base,
data = subject_data)
summary(stage2_intercept_model)
# Slope model
stage2_slope_model <- lm(year ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc +
abpet_base + taupet_base + cdrsb_base,
data = subject_data %>%
rename(year = `year`))  # Ensure slope column named "year"
summary(stage2_slope_model)
# Optional: Plot Stage 1 fits for visualization
ggplot(alz_long, aes(x = year, y = bprs, group = patid)) +
geom_point(alpha = 0.5) +
geom_line(data = subject_data %>%
rowwise() %>%
mutate(years = list(0:4)) %>%
unnest(cols = c(years)) %>%
mutate(bprs_pred = `(Intercept)` + year * years),
aes(x = years, y = bprs_pred, group = patid),
color = "red", alpha = 0.5) +
labs(title = "Stage 1: Subject-specific linear regressions for BPRS") +
theme_minimal()
# Load packages
library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
library(nlme)
# Stage 1: Linear regressions for evey subject
stage1_models <- alz_long %>%
group_by(patid) %>%
group_map(~ lm(bprs ~ year, data = .x), .keep = TRUE)
# Extract coefficients for each subject
beta_coefs <- map_dfr(stage1_models, coef) %>%
mutate(patid = alz_long %>% group_by(patid) %>% group_keys() %>% pull(patid))
head(beta_coefs)
# Merge baseline covariates
subject_data <- alz_long %>%
select(patid, trial, sex, age, edu, bmi, inkomen, job, adl, wzc, abpet_base, taupet_base, cdrsb_base) %>%
distinct() %>%
left_join(beta_coefs, by = "patid")
# Reshape data for GLS
stage2_data <- subject_data %>%
select(patid, `(Intercept)`, year, trial, sex, age, edu, bmi, inkomen, job, adl, wzc,
abpet_base, taupet_base, cdrsb_base) %>%
pivot_longer(cols = c(`(Intercept)`, year),
names_to = "param",
values_to = "beta")
stage2_data$param <- factor(stage2_data$param)
# Stage 2 GLS model with correlation between intercept and slope
stage2_gls_model <- gls(
beta ~ param + trial + sex + age + edu + bmi + inkomen + job + adl + wzc +
abpet_base + taupet_base + cdrsb_base,
data = stage2_data,
correlation = corSymm(form = ~ 1 | patid),   # correlation structure per patient
weights = varIdent(form = ~ 1 | param),     # allow different variances for intercept/slope
method = "ML",
na.action = na.exclude
)
summary(stage2_gls_model)
# Optional: Plot Stage 1 fits for visualization
ggplot(alz_long, aes(x = year, y = bprs, group = patid)) +
geom_point(alpha = 0.5) +
geom_line(data = subject_data %>%
rowwise() %>%
mutate(years = list(0:4)) %>%
unnest(cols = c(years)) %>%
mutate(bprs_pred = `(Intercept)` + year * years),
aes(x = years, y = bprs_pred, group = patid),
color = "red", alpha = 0.5) +
labs(title = "Stage 1: Subject-specific linear regressions for BPRS") +
theme_minimal()
summary(stage2_gls_model)
summary(stage2_slope_model)
summary(stage2_gls_model)
# Load packages
library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
library(nlme)
# Stage 1: Linear regressions for every subject
stage1_models <- alz_long %>%
group_by(patid) %>%
group_map(~ gls(bprs ~ year,
correlation = corAR1(form = ~ year),
data = .x,
method = "ML"), .keep = TRUE)
summary(stage2_slope_model)
# Stage 1
stage1_models <- alz_long %>%
group_by(patid) %>%
group_map(~ lm(bprs ~ year, data = .x), .keep = TRUE)
# Extract coefficients for each subject
beta_coefs <- map_dfr(stage1_models, coef) %>%
mutate(patid = alz_long %>% group_by(patid) %>% group_keys() %>% pull(patid))
head(beta_coefs)
# Merge baseline covariates
subject_data <- alz_long %>%
select(patid, trial, sex, age, edu, bmi, inkomen, job, adl, wzc, abpet_base, taupet_base, cdrsb_base) %>%
distinct() %>%
left_join(beta_coefs, by = "patid")
# Intercept model
stage2_intercept_model <- lm(`(Intercept)` ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc +
abpet_base + taupet_base + cdrsb_base,
data = subject_data)
summary(stage2_intercept_model)
# Slope model
stage2_slope_model <- lm(year ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc +
abpet_base + taupet_base + cdrsb_base,
data = subject_data %>%
rename(year = `year`))
summary(stage2_slope_model)
summary(stage2_slope_model)
summary(stage2_intercept_model)
summary(stage2_slope_model)
# Stage 2 GLS model with correlation between intercept and slope
stage2_gls_model <- gls(
beta ~ param + trial + sex + age + edu + bmi + inkomen + job + adl + wzc +
abpet_base + taupet_base + cdrsb_base,
data = stage2_data,
correlation = corSymm(form = ~ 1 | patid),   # correlation structure per patient
weights = varIdent(form = ~ 1 | param),     # allow different variances for intercept/slope
method = "ML",
na.action = na.exclude
)
summary(stage2_gls_model)
View(stage2_gls_model)
# Plot Stage 1 fits with slope coloring
ggplot(alz_long, aes(x = year, y = bprs, group = patid)) +
geom_point(alpha = 0.5) +
geom_line(data = subject_data %>%
rowwise() %>%
mutate(years = list(0:4),
bprs_pred = `(Intercept)` + year * years) %>%
unnest(cols = c(years)) %>%
mutate(slope_category = ifelse(year > 0, year, NA)),  # just to attach slope info
aes(x = years, y = bprs_pred, group = patid, color = slope_category),
alpha = 0.7) +
scale_color_gradient2(low = "blue", mid = "red", high = "darkred", midpoint = 0,
name = "Slope") +
labs(title = "Stage 1: Subject-specific linear regressions for BPRS") +
theme_minimal()
# Optional: Plot Stage 1 fits for visualization
ggplot(alz_long, aes(x = year, y = bprs, group = patid)) +
geom_point(alpha = 0.5) +
geom_line(data = subject_data %>%
rowwise() %>%
mutate(years = list(0:6)) %>%
unnest(cols = c(years)) %>%
mutate(bprs_pred = `(Intercept)` + year * years),
aes(x = years, y = bprs_pred, group = patid),
color = "red", alpha = 0.5) +
labs(title = "Stage 1: Subject-specific linear regressions for BPRS") +
theme_minimal()
# Prepare predicted values for plotting
pred_data <- subject_data %>%
rowwise() %>%
mutate(years = list(0:6)) %>%
unnest(cols = c(years)) %>%
mutate(bprs_pred = `(Intercept)` + year * years)
# Calculate average trajectory
avg_trajectory <- pred_data %>%
group_by(years) %>%
summarize(avg_bprs = mean(bprs_pred))
# Improved plot
ggplot() +
# Individual trajectories
geom_line(data = pred_data,
aes(x = years, y = bprs_pred, group = patid),
color = "red", alpha = 0.2) +
# Individual points
geom_point(data = alz_long, aes(x = year, y = bprs), alpha = 0.5) +
# Average trajectory
geom_line(data = avg_trajectory,
aes(x = years, y = avg_bprs),
color = "blue", size = 1.2) +
labs(title = "Stage 1: Subject-specific linear regressions for BPRS",
subtitle = "Red = individual fits, Blue = average trajectory",
x = "Year", y = "BPRS") +
theme_minimal()
# Plot Stage the Predictions!
ggplot(alz_long, aes(x = year, y = bprs, group = patid)) +
geom_point(alpha = 0.5) +
geom_line(data = subject_data %>%
rowwise() %>%
mutate(years = list(0:6)) %>%
unnest(cols = c(years)) %>%
mutate(bprs_pred = `(Intercept)` + year * years), # Calculates the Prediction!!!
aes(x = years, y = bprs_pred, group = patid),
color = "red", alpha = 0.5) +
labs(title = "Stage 1: Subject-specific linear regressions for BPRS") +
theme_minimal()
