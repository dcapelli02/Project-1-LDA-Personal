library(nlme)
# Llegir dades
alz <- read_sas("C:/Users/win11/Documents/Guillem/Erasmus/Assignatures/Longitudinal Data Analysis/Project-1-LDA-Personal/alzheimer25.sas7bdat")
# Convertir variables qualitatives a factors
alz$trial <- factor(alz$trial)
alz$sex <- factor(alz$sex, levels = c(0, 1), labels = c("male", "female"))
alz$edu <- factor(alz$edu, levels = c(1,2,3,4),
labels = c("Primary Ed.", "Lower Secondary Ed.", "Upper Secondary Ed.", "Higher Ed."))
alz$job <- factor(alz$job, levels = c(0, 1), labels = c("No job", "Job"))
alz$wzc <- factor(alz$wzc, levels = c(0, 1), labels = c("Home", "Residence"))
alz$abpet_base <- alz$abpet0
alz$taupet_base <- alz$taupet0
alz$cdrsb_base <- alz$cdrsb0
# Transformar a long format
alz_long <- pivot_longer(
alz,
cols = matches("^(bprs|cdrsb|abpet|taupet)\\d+$"),
names_to = c(".value", "year"),
names_pattern = "(bprs|cdrsb|abpet|taupet)(\\d+)"
)
# Convertir year a numèric
alz_long$year <- as.numeric(as.character(alz_long$year))
vars_long <- c("cdrsb", "bprs", "abpet", "taupet")
for (var in vars_long) {
cat("\n==============================\n")
cat("Variable:", var, "\n")
# Mean & SD
summary_by_year <- alz_long %>%
group_by(year) %>%
summarise(
mean_val = mean(.data[[var]], na.rm = TRUE),
sd_val   = sd(.data[[var]], na.rm = TRUE)
)
# Gràfic de mitjana amb ribbon
print(
ggplot(summary_by_year, aes(x = year, y = mean_val)) +
geom_line(color = "red", size = 1.2) +
geom_ribbon(aes(ymin = mean_val - sd_val, ymax = mean_val + sd_val),
alpha = 0.2, fill = "blue") +
labs(title = paste(var, "evolution"), x = "Year", y = var) +
theme_minimal()
)
# Gràfic de SD
print(
ggplot(summary_by_year, aes(x = year, y = sd_val)) +
geom_line(color = "darkgreen", size = 1.2) +
geom_point(color = "darkgreen", size = 2) +
labs(title = paste(var, "SD evolution (variance structure)"),
x = "Year", y = paste("SD of", var)) +
theme_minimal()
)
# Correlation
wide_df <- alz_long %>%
select(patid, year, .data[[var]]) %>%
pivot_wider(names_from = year, values_from = var)
cor_mat <- cor(wide_df[,-1], use = "pairwise.complete.obs")
print(cor_mat)
print(
ggcorrplot(cor_mat,
method = "circle",
lab = TRUE,
title = paste("Correlation structure of", var, "over years"))
)
}
model_gls_1 <- gls(
bprs ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + cdrsb_base +
abpet_base + taupet_base + (trial + sex + age + edu + bmi + inkomen +
job + adl + wzc + cdrsb_base + abpet_base + taupet_base) * year,
correlation = corAR1(form = ~ year | patid),
weights = varIdent(form = ~ 1 | year),
data = alz_long,
method = "ML",
na.action = na.exclude
)
model_gls_2 <- gls(
bprs ~ trial + sex + age + edu + job + adl + wzc + cdrsb_base +
(sex + age + job + adl + wzc + cdrsb_base) * year,
correlation = corAR1(form = ~ year | patid),
weights = varIdent(form = ~ 1 | year),
data = alz_long,
method = "ML",
na.action = na.exclude
)
model_gls_3 <- gls(
bprs ~ trial + sex + age + adl + job + (wzc + cdrsb_base) * year,
correlation = corAR1(form = ~ year | patid),
weights = varIdent(form = ~ 1 | year),
data = alz_long,
method = "ML",
na.action = na.exclude
)
anova(model_gls_1, model_gls_2, model_gls_3)
alz_long <- alz_long %>%
arrange(patid, year) %>%
group_by(patid) %>%
mutate(year_seq = row_number()) %>%
ungroup()
model_lme_1 <- lme(
bprs ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + cdrsb_base +
abpet_base + taupet_base + (trial + sex + age + edu + bmi + inkomen +
job + adl + wzc + cdrsb_base + abpet_base + taupet_base) * year,
random = ~ 1 | patid,
correlation = corSymm(form = ~ year_seq | patid),
weights = varIdent(form = ~ 1 | year),
data = alz_long,
method = "ML",
na.action = na.exclude
)
model_lme_3 <- lme(
bprs ~ trial + sex + age + adl + job + (wzc + cdrsb_base) * year,
random = ~ 1 | patid,
correlation = corSymm(form = ~ year_seq | patid),
weights = varIdent(form = ~ 1 | year),
data = alz_long,
method = "ML",
na.action = na.exclude
)
model_lme_3 <- lme(
bprs ~ trial + sex + age + adl + job + (wzc + cdrsb_base) * year,
random = ~ 1 | patid,
correlation = corSymm(form = ~ year_seq | patid),
weights = varIdent(form = ~ 1 | year_seq),
data = alz_long,
method = "ML",
na.action = na.exclude
)
model_lme_3 <- lme(
bprs ~ trial + sex + age + adl + job + (wzc + cdrsb_base) * year,
random = ~ year_seq | patid,
correlation = corSymm(form = ~ year_seq | patid),
weights = varIdent(form = ~ 1 | year_seq),
data = alz_long,
method = "ML",
na.action = na.exclude
)
model_lme_3 <- lme(
bprs ~ trial + sex + age + adl + job + (wzc + cdrsb_base) * year,
random = ~ year_seq | patid,
correlation = corSymm(form = ~ year_seq | patid),
weights = varIdent(form = ~ 1 | year_seq),
data = alz_long,
na.action = na.omit
)
model_lme_3 <- lme(
bprs ~ (wzc + cdrsb_base) * year,
random = ~ year_seq | patid,
correlation = corSymm(form = ~ year_seq | patid),
weights = varIdent(form = ~ 1 | year_seq),
data = alz_long,
na.action = na.omit
)
alz_long <- alz_long %>%
arrange(patid, year) %>%
group_by(patid) %>%
mutate(year_seq = row_number()) %>%
ungroup()
model_gls_4 <- gls(
bprs ~ sex + age + adl + job + (wzc + cdrsb_base) * year,
correlation = corAR1(form = ~ year | patid),
weights = varIdent(form = ~ 1 | year),
data = alz_long,
method = "ML",
na.action = na.exclude
)
anova(model_gls_1, model_gls_2, model_gls_3, model_gls_4)
# Carregar paquets
library(haven)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggcorrplot)
library(nlme)
# Llegir dades
alz <- read_sas("C:/Users/win11/Documents/Guillem/Erasmus/Assignatures/Longitudinal Data Analysis/Project-1-LDA-Personal/alzheimer25.sas7bdat")
# Convertir variables qualitatives a factors
alz$trial <- factor(alz$trial)
alz$sex <- factor(alz$sex, levels = c(0, 1), labels = c("male", "female"))
alz$edu <- factor(alz$edu, levels = c(1,2,3,4),
labels = c("Primary Ed.", "Lower Secondary Ed.", "Upper Secondary Ed.", "Higher Ed."))
alz$job <- factor(alz$job, levels = c(0, 1), labels = c("No job", "Job"))
alz$wzc <- factor(alz$wzc, levels = c(0, 1), labels = c("Home", "Residence"))
alz$abpet_base <- alz$abpet0
alz$taupet_base <- alz$taupet0
alz$cdrsb_base <- alz$cdrsb0
# Transformar a long format
alz_long <- pivot_longer(
alz,
cols = matches("^(bprs|cdrsb|abpet|taupet)\\d+$"),
names_to = c(".value", "year"),
names_pattern = "(bprs|cdrsb|abpet|taupet)(\\d+)"
)
# Convertir year a numèric
alz_long$year <- as.numeric(as.character(alz_long$year))
vars_long <- c("cdrsb", "bprs", "abpet", "taupet")
for (var in vars_long) {
cat("\n==============================\n")
cat("Variable:", var, "\n")
# Mean & SD
summary_by_year <- alz_long %>%
group_by(year) %>%
summarise(
mean_val = mean(.data[[var]], na.rm = TRUE),
sd_val   = sd(.data[[var]], na.rm = TRUE)
)
# Gràfic de mitjana amb ribbon
print(
ggplot(summary_by_year, aes(x = year, y = mean_val)) +
geom_line(color = "red", size = 1.2) +
geom_ribbon(aes(ymin = mean_val - sd_val, ymax = mean_val + sd_val),
alpha = 0.2, fill = "blue") +
labs(title = paste(var, "evolution"), x = "Year", y = var) +
theme_minimal()
)
# Gràfic de SD
print(
ggplot(summary_by_year, aes(x = year, y = sd_val)) +
geom_line(color = "darkgreen", size = 1.2) +
geom_point(color = "darkgreen", size = 2) +
labs(title = paste(var, "SD evolution (variance structure)"),
x = "Year", y = paste("SD of", var)) +
theme_minimal()
)
# Correlation
wide_df <- alz_long %>%
select(patid, year, .data[[var]]) %>%
pivot_wider(names_from = year, values_from = var)
cor_mat <- cor(wide_df[,-1], use = "pairwise.complete.obs")
print(cor_mat)
print(
ggcorrplot(cor_mat,
method = "circle",
lab = TRUE,
title = paste("Correlation structure of", var, "over years"))
)
}
model_gls_1 <- gls(
bprs ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + cdrsb_base +
abpet_base + taupet_base + (trial + sex + age + edu + bmi + inkomen +
job + adl + wzc + cdrsb_base + abpet_base + taupet_base) * year,
correlation = corAR1(form = ~ year | patid),
weights = varIdent(form = ~ 1 | year),
data = alz_long,
method = "ML",
na.action = na.exclude
)
summary(alz_long)
# Ensure data is sorted properly
alz_long <- alz_long %>%
arrange(patid, year)
# Define the outcome variable
outcome <- "bprs"
# Compute summary statistics: AUC, endpoint, increment
summary_stats <- alz_long %>%
group_by(patid) %>%
summarise(
trial = first(trial),
sex = first(sex),
age = first(age),
edu = first(edu),
job = first(job),
adl = first(adl),
wzc = first(wzc),
cdrsb_base = first(cdrsb_base),
# baseline value
y0 = first(.data[[outcome]]),
# last available measurement
yini = last(na.omit(.data[[outcome]])),
# last time point observed
tmax = last(na.omit(year)),
# increment (change)
increment = yini - y0,
# Area Under the Curve (AUC) using trapezoidal rule
AUC = sum(diff(year) * (head(.data[[outcome]], -1) + tail(.data[[outcome]], -1)) / 2, na.rm = TRUE)
)
model_auc <- lm(AUC ~ sex + age + edu + job + adl + wzc + cdrsb_base, data = summary_stats)
summary(model_auc)
model_endpoint <- lm(yini ~ sex + age + edu + job + adl + wzc + cdrsb_base, data = summary_stats)
summary(model_endpoint)
model_increment <- lm(increment ~ sex + age + edu + job + adl + wzc + cdrsb_base, data = summary_stats)
summary(model_increment)
model_ancova <- lm(yini ~ y0 + sex + age + edu + job + adl + wzc + cdrsb_base, data = summary_stats)
summary(model_ancova)
AIC(model_auc, model_endpoint, model_increment, model_ancova)
plot(summary_stats$AUC, fitted(model_auc), main = "Predicted vs Observed AUC", xlab = "Observed", ylab = "Predicted")
summary(summary_stats)
# Ensure data is sorted properly
alz_long <- alz_long %>%
arrange(patid, year)
# Define the outcome variable
outcome <- "bprs"
# Compute summary statistics: AUC, endpoint, increment
summary_stats <- alz_long %>%
group_by(patid) %>%
summarise(
trial = first(trial),
sex = first(sex),
age = first(age),
edu = first(edu),
bmi = first(bmi),
inkomen = first(inkomen),
job = first(job),
adl = first(adl),
wzc = first(wzc),
abpet_base = first(abpet_base),
taupet_base = first(taupet_base)
cdrsb_base = first(cdrsb_base),
summary(summary_stats)
# Ensure data is sorted properly
alz_long <- alz_long %>%
arrange(patid, year)
# Define the outcome variable
outcome <- "bprs"
# Compute summary statistics: AUC, endpoint, increment
summary_stats <- alz_long %>%
group_by(patid) %>%
summarise(
trial = first(trial),
sex = first(sex),
age = first(age),
edu = first(edu),
bmi = first(bmi),
inkomen = first(inkomen),
job = first(job),
adl = first(adl),
wzc = first(wzc),
abpet_base = first(abpet_base),
taupet_base = first(taupet_base),
cdrsb_base = first(cdrsb_base),
# baseline value
y0 = first(.data[[outcome]]),
# last available measurement
yini = last(na.omit(.data[[outcome]])),
# last time point observed
tmax = last(na.omit(year)),
# increment (change)
increment = yini - y0,
# Area Under the Curve (AUC) using trapezoidal rule
AUC = sum(diff(year) * (head(.data[[outcome]], -1) + tail(.data[[outcome]], -1)) / 2, na.rm = TRUE)
)
summary(summary_stats)
# Carregar paquets
library(haven)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggcorrplot)
library(nlme)
# Llegir dades
alz <- read_sas("C:/Users/win11/Documents/Guillem/Erasmus/Assignatures/Longitudinal Data Analysis/Project-1-LDA-Personal/alzheimer25.sas7bdat")
# Convertir variables qualitatives a factors
alz$trial <- factor(alz$trial)
alz$sex <- factor(alz$sex, levels = c(0, 1), labels = c("male", "female"))
alz$edu <- factor(alz$edu, levels = c(1,2,3,4),
labels = c("Primary Ed.", "Lower Secondary Ed.", "Upper Secondary Ed.", "Higher Ed."))
alz$job <- factor(alz$job, levels = c(0, 1), labels = c("No job", "Job"))
alz$wzc <- factor(alz$wzc, levels = c(0, 1), labels = c("Home", "Residence"))
alz$abpet_base <- alz$abpet0
alz$taupet_base <- alz$taupet0
alz$cdrsb_base <- alz$cdrsb0
# Transformar a long format
alz_long <- pivot_longer(
alz,
cols = matches("^(bprs|cdrsb|abpet|taupet)\\d+$"),
names_to = c(".value", "year"),
names_pattern = "(bprs|cdrsb|abpet|taupet)(\\d+)"
)
# Convertir year a numèric
alz_long$year <- as.numeric(as.character(alz_long$year))
vars_long <- c("cdrsb", "bprs", "abpet", "taupet")
for (var in vars_long) {
cat("\n==============================\n")
cat("Variable:", var, "\n")
# Mean & SD
summary_by_year <- alz_long %>%
group_by(year) %>%
summarise(
mean_val = mean(.data[[var]], na.rm = TRUE),
sd_val   = sd(.data[[var]], na.rm = TRUE)
)
# Gràfic de mitjana amb ribbon
print(
ggplot(summary_by_year, aes(x = year, y = mean_val)) +
geom_line(color = "red", size = 1.2) +
geom_ribbon(aes(ymin = mean_val - sd_val, ymax = mean_val + sd_val),
alpha = 0.2, fill = "blue") +
labs(title = paste(var, "evolution"), x = "Year", y = var) +
theme_minimal()
)
# Gràfic de SD
print(
ggplot(summary_by_year, aes(x = year, y = sd_val)) +
geom_line(color = "darkgreen", size = 1.2) +
geom_point(color = "darkgreen", size = 2) +
labs(title = paste(var, "SD evolution (variance structure)"),
x = "Year", y = paste("SD of", var)) +
theme_minimal()
)
# Correlation
wide_df <- alz_long %>%
select(patid, year, .data[[var]]) %>%
pivot_wider(names_from = year, values_from = var)
cor_mat <- cor(wide_df[,-1], use = "pairwise.complete.obs")
print(cor_mat)
print(
ggcorrplot(cor_mat,
method = "circle",
lab = TRUE,
title = paste("Correlation structure of", var, "over years"))
)
}
model_gls_1 <- gls(
bprs ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + cdrsb_base +
abpet_base + taupet_base + (trial + sex + age + edu + bmi + inkomen +
job + adl + wzc + cdrsb_base + abpet_base + taupet_base) * year,
correlation = corAR1(form = ~ year | patid),
weights = varIdent(form = ~ 1 | year),
data = alz_long,
method = "ML",
na.action = na.exclude
)
model_gls_2 <- gls(
bprs ~ trial + sex + age + edu + job + adl + wzc + cdrsb_base +
(sex + age + job + adl + wzc + cdrsb_base) * year,
correlation = corAR1(form = ~ year | patid),
weights = varIdent(form = ~ 1 | year),
data = alz_long,
method = "ML",
na.action = na.exclude
)
model_gls_3 <- gls(
bprs ~ trial + sex + age + adl + job + (wzc + cdrsb_base) * year,
correlation = corAR1(form = ~ year | patid),
weights = varIdent(form = ~ 1 | year),
data = alz_long,
method = "ML",
na.action = na.exclude
)
#Without Trial - It has larger BIC
model_gls_4 <- gls(
bprs ~ sex + age + adl + job + (wzc + cdrsb_base) * year,
correlation = corAR1(form = ~ year | patid),
weights = varIdent(form = ~ 1 | year),
data = alz_long,
method = "ML",
na.action = na.exclude
)
anova(model_gls_1, model_gls_2, model_gls_3, model_gls_4)
#alz_long <- alz_long %>%
#alz_long <- alz_long %>%
#  arrange(patid, year) %>%
#alz_long <- alz_long %>%
#  arrange(patid, year) %>%
#  group_by(patid) %>%
#alz_long <- alz_long %>%
#  arrange(patid, year) %>%
#  group_by(patid) %>%
#  mutate(year_seq = row_number()) %>%
# Define the outcome variable
outcome <- "bprs"
# Compute summary statistics: AUC, endpoint, increment
summary_stats <- alz_long %>%
group_by(patid) %>%
summarise(
trial = first(trial),
sex = first(sex),
age = first(age),
edu = first(edu),
bmi = first(bmi),
inkomen = first(inkomen),
job = first(job),
adl = first(adl),
wzc = first(wzc),
abpet_base = first(abpet_base),
taupet_base = first(taupet_base),
cdrsb_base = first(cdrsb_base),
# Baseline Value
y0 = first(.data[[outcome]]),
# Last Available Measurement
yini = last(na.omit(.data[[outcome]])),
# Last Time Point Observed
tmax = last(na.omit(year)),
# Increment
increment = yini - y0,
# Area Under the Curve (AUC) using trapezoidal rule
AUC = sum(diff(year) * (head(.data[[outcome]], -1) + tail(.data[[outcome]], -1)) / 2, na.rm = TRUE)
)
summary(summary_stats)
#AUC: Area Under the Curve
model_auc <- lm(AUC ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_auc)
#Endpoints
model_endpoint <- lm(yini ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_endpoint)
#Endpoints (Depending also on the bprs baseline) Linear Regression including bprs as a predictor
model_ancova <- lm(yini ~ y0 + trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_ancova)
#Increment
model_increment <- lm(increment ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_increment)
AIC(model_auc, model_endpoint, model_increment, model_ancova)
plot(summary_stats$AUC, fitted(model_auc),
main = "Predicted vs Observed AUC",
xlab = "Observed",
ylab = "Predicted")
abline(0, 1, col = "red")
anova(model_auc, model_endpoint, model_increment, model_ancova)
AIC(model_auc, model_endpoint, model_increment, model_ancova)
BIC(model_auc, model_endpoint, model_increment, model_ancova)
