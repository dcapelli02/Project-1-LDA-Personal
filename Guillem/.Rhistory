increment = yini - y0,
# Area Under the Curve (AUC) using trapezoidal rule
AUC = sum(diff(year) * (head(.data[[outcome]], -1) + tail(.data[[outcome]], -1)) / 2, na.rm = TRUE)
)
summary(summary_stats)
# Carregar paquets
library(haven)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggcorrplot)
library(nlme)
# Llegir dades
alz <- read_sas("C:/Users/win11/Documents/Guillem/Erasmus/Assignatures/Longitudinal Data Analysis/Project-1-LDA-Personal/alzheimer25.sas7bdat")
# Convertir variables qualitatives a factors
alz$trial <- factor(alz$trial)
alz$sex <- factor(alz$sex, levels = c(0, 1), labels = c("male", "female"))
alz$edu <- factor(alz$edu, levels = c(1,2,3,4),
labels = c("Primary Ed.", "Lower Secondary Ed.", "Upper Secondary Ed.", "Higher Ed."))
alz$job <- factor(alz$job, levels = c(0, 1), labels = c("No job", "Job"))
alz$wzc <- factor(alz$wzc, levels = c(0, 1), labels = c("Home", "Residence"))
alz$abpet_base <- alz$abpet0
alz$taupet_base <- alz$taupet0
alz$cdrsb_base <- alz$cdrsb0
# Transformar a long format
alz_long <- pivot_longer(
alz,
cols = matches("^(bprs|cdrsb|abpet|taupet)\\d+$"),
names_to = c(".value", "year"),
names_pattern = "(bprs|cdrsb|abpet|taupet)(\\d+)"
)
# Convertir year a numèric
alz_long$year <- as.numeric(as.character(alz_long$year))
vars_long <- c("cdrsb", "bprs", "abpet", "taupet")
for (var in vars_long) {
cat("\n==============================\n")
cat("Variable:", var, "\n")
# Mean & SD
summary_by_year <- alz_long %>%
group_by(year) %>%
summarise(
mean_val = mean(.data[[var]], na.rm = TRUE),
sd_val   = sd(.data[[var]], na.rm = TRUE)
)
# Gràfic de mitjana amb ribbon
print(
ggplot(summary_by_year, aes(x = year, y = mean_val)) +
geom_line(color = "red", size = 1.2) +
geom_ribbon(aes(ymin = mean_val - sd_val, ymax = mean_val + sd_val),
alpha = 0.2, fill = "blue") +
labs(title = paste(var, "evolution"), x = "Year", y = var) +
theme_minimal()
)
# Gràfic de SD
print(
ggplot(summary_by_year, aes(x = year, y = sd_val)) +
geom_line(color = "darkgreen", size = 1.2) +
geom_point(color = "darkgreen", size = 2) +
labs(title = paste(var, "SD evolution (variance structure)"),
x = "Year", y = paste("SD of", var)) +
theme_minimal()
)
# Correlation
wide_df <- alz_long %>%
select(patid, year, .data[[var]]) %>%
pivot_wider(names_from = year, values_from = var)
cor_mat <- cor(wide_df[,-1], use = "pairwise.complete.obs")
print(cor_mat)
print(
ggcorrplot(cor_mat,
method = "circle",
lab = TRUE,
title = paste("Correlation structure of", var, "over years"))
)
}
model_gls_1 <- gls(
bprs ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + cdrsb_base +
abpet_base + taupet_base + (trial + sex + age + edu + bmi + inkomen +
job + adl + wzc + cdrsb_base + abpet_base + taupet_base) * year,
correlation = corAR1(form = ~ year | patid),
weights = varIdent(form = ~ 1 | year),
data = alz_long,
method = "ML",
na.action = na.exclude
)
model_gls_2 <- gls(
bprs ~ trial + sex + age + edu + job + adl + wzc + cdrsb_base +
(sex + age + job + adl + wzc + cdrsb_base) * year,
correlation = corAR1(form = ~ year | patid),
weights = varIdent(form = ~ 1 | year),
data = alz_long,
method = "ML",
na.action = na.exclude
)
model_gls_3 <- gls(
bprs ~ trial + sex + age + adl + job + (wzc + cdrsb_base) * year,
correlation = corAR1(form = ~ year | patid),
weights = varIdent(form = ~ 1 | year),
data = alz_long,
method = "ML",
na.action = na.exclude
)
#Without Trial - It has larger BIC
model_gls_4 <- gls(
bprs ~ sex + age + adl + job + (wzc + cdrsb_base) * year,
correlation = corAR1(form = ~ year | patid),
weights = varIdent(form = ~ 1 | year),
data = alz_long,
method = "ML",
na.action = na.exclude
)
anova(model_gls_1, model_gls_2, model_gls_3, model_gls_4)
#alz_long <- alz_long %>%
#alz_long <- alz_long %>%
#  arrange(patid, year) %>%
#alz_long <- alz_long %>%
#  arrange(patid, year) %>%
#  group_by(patid) %>%
#alz_long <- alz_long %>%
#  arrange(patid, year) %>%
#  group_by(patid) %>%
#  mutate(year_seq = row_number()) %>%
# Define the outcome variable
outcome <- "bprs"
# Compute summary statistics: AUC, endpoint, increment
summary_stats <- alz_long %>%
group_by(patid) %>%
summarise(
trial = first(trial),
sex = first(sex),
age = first(age),
edu = first(edu),
bmi = first(bmi),
inkomen = first(inkomen),
job = first(job),
adl = first(adl),
wzc = first(wzc),
abpet_base = first(abpet_base),
taupet_base = first(taupet_base),
cdrsb_base = first(cdrsb_base),
# Baseline Value
y0 = first(.data[[outcome]]),
# Last Available Measurement
yini = last(na.omit(.data[[outcome]])),
# Last Time Point Observed
tmax = last(na.omit(year)),
# Increment
increment = yini - y0,
# Area Under the Curve (AUC) using trapezoidal rule
AUC = sum(diff(year) * (head(.data[[outcome]], -1) + tail(.data[[outcome]], -1)) / 2, na.rm = TRUE)
)
summary(summary_stats)
#AUC: Area Under the Curve
model_auc <- lm(AUC ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_auc)
#Endpoints
model_endpoint <- lm(yini ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_endpoint)
#Endpoints (Depending also on the bprs baseline) Linear Regression including bprs as a predictor
model_ancova <- lm(yini ~ y0 + trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_ancova)
#Increment
model_increment <- lm(increment ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_increment)
AIC(model_auc, model_endpoint, model_increment, model_ancova)
plot(summary_stats$AUC, fitted(model_auc),
main = "Predicted vs Observed AUC",
xlab = "Observed",
ylab = "Predicted")
abline(0, 1, col = "red")
anova(model_auc, model_endpoint, model_increment, model_ancova)
AIC(model_auc, model_endpoint, model_increment, model_ancova)
BIC(model_auc, model_endpoint, model_increment, model_ancova)
summary(model_auc)
summary(model_endpoint)
summary(model_ancova)
summary(model_increment)
AIC(model_auc, model_endpoint, model_increment, model_ancova)
BIC(model_auc, model_endpoint, model_increment, model_ancova)
library(ggplot2)
# Create predicted vs observed plots for all models
p1 <- ggplot(summary_stats, aes(x = AUC, y = fitted(model_auc))) +
geom_point(alpha = 0.6) +
geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
labs(title = "Predicted vs Observed: AUC",
x = "Observed AUC",
y = "Predicted AUC") +
theme_minimal()
p2 <- ggplot(summary_stats, aes(x = yini, y = fitted(model_endpoint))) +
geom_point(alpha = 0.6) +
geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
labs(title = "Predicted vs Observed: Endpoint",
x = "Observed Endpoint",
y = "Predicted Endpoint") +
theme_minimal()
p3 <- ggplot(summary_stats, aes(x = yini, y = fitted(model_ancova))) +
geom_point(alpha = 0.6) +
geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
labs(title = "Predicted vs Observed: Endpoint (ANCOVA)",
x = "Observed Endpoint",
y = "Predicted Endpoint") +
theme_minimal()
p4 <- ggplot(summary_stats, aes(x = increment, y = fitted(model_increment))) +
geom_point(alpha = 0.6) +
geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
labs(title = "Predicted vs Observed: Increment",
x = "Observed Increment",
y = "Predicted Increment") +
theme_minimal()
grid.arrange(p1, p2, p3, p4, ncol = 2)
library(gridExtra)
grid.arrange(p1, p2, p3, p4, ncol = 2)
grid.arrange(p1, p2, p3, p4, ncol = 2)
# Residuals vs Fitted plots for all models
par(mfrow = c(2, 3))
plot(fitted(model_auc), residuals(model_auc),
main = "Residuals vs Fitted: AUC",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
plot(fitted(model_endpoint), residuals(model_endpoint),
main = "Residuals vs Fitted: Endpoint",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
plot(fitted(model_ancova), residuals(model_ancova),
main = "Residuals vs Fitted: Endpoint (ANCOVA)",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
plot(fitted(model_increment), residuals(model_increment),
main = "Residuals vs Fitted: Increment",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
if(exists("model_slope")) {
plot(fitted(model_slope), residuals(model_slope),
main = "Residuals vs Fitted: Slope",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
}
par(mfrow = c(1, 1))
# Residuals vs Fitted plots for all models
par(mfrow = c(2, 2))
plot(fitted(model_auc), residuals(model_auc),
main = "Residuals vs Fitted: AUC",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
plot(fitted(model_endpoint), residuals(model_endpoint),
main = "Residuals vs Fitted: Endpoint",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
plot(fitted(model_ancova), residuals(model_ancova),
main = "Residuals vs Fitted: Endpoint (ANCOVA)",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
plot(fitted(model_increment), residuals(model_increment),
main = "Residuals vs Fitted: Increment",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
par(mfrow = c(1, 1))
library(ggplot2)
library(gridExtra)
# Define the outcome variable
outcome <- "bprs"
# Compute summary statistics: AUC, endpoint, increment
summary_stats <- alz_long %>%
group_by(patid) %>%
summarise(
trial = first(trial),
sex = first(sex),
age = first(age),
edu = first(edu),
bmi = first(bmi),
inkomen = first(inkomen),
job = first(job),
adl = first(adl),
wzc = first(wzc),
abpet_base = first(abpet_base),
taupet_base = first(taupet_base),
cdrsb_base = first(cdrsb_base),
# Baseline Value
y0 = first(.data[[outcome]]),
# Last Available Measurement
yini = last(na.omit(.data[[outcome]])),
# Last Time Point Observed
tmax = last(na.omit(year)),
# Increment
increment = yini - y0,
# Area Under the Curve (AUC) using trapezoidal rule
AUC = sum(diff(year) * (head(.data[[outcome]], -1) + tail(.data[[outcome]], -1)) / 2, na.rm = TRUE)
)
summary(model_auc)
#Endpoints
model_endpoint <- lm(yini ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_endpoint)
#Endpoints (Depending also on the bprs baseline) Linear Regression including bprs as a predictor
model_ancova <- lm(yini ~ y0 + trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_ancova)
#Increment
model_increment <- lm(increment ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_increment)
AIC(model_auc, model_endpoint, model_increment, model_ancova)
BIC(model_auc, model_endpoint, model_increment, model_ancova)
# Create predicted vs observed plots for all models
p1 <- ggplot(summary_stats, aes(x = AUC, y = fitted(model_auc))) +
geom_point(alpha = 0.6) +
geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
labs(title = "Predicted vs Observed: AUC",
x = "Observed AUC",
y = "Predicted AUC") +
theme_minimal()
p2 <- ggplot(summary_stats, aes(x = yini, y = fitted(model_endpoint))) +
geom_point(alpha = 0.6) +
geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
labs(title = "Predicted vs Observed: Endpoint",
x = "Observed Endpoint",
y = "Predicted Endpoint") +
theme_minimal()
p3 <- ggplot(summary_stats, aes(x = yini, y = fitted(model_ancova))) +
geom_point(alpha = 0.6) +
geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
labs(title = "Predicted vs Observed: Endpoint (ANCOVA)",
x = "Observed Endpoint",
y = "Predicted Endpoint") +
theme_minimal()
p4 <- ggplot(summary_stats, aes(x = increment, y = fitted(model_increment))) +
geom_point(alpha = 0.6) +
geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
labs(title = "Predicted vs Observed: Increment",
x = "Observed Increment",
y = "Predicted Increment") +
theme_minimal()
grid.arrange(p1, p2, p3, p4, ncol = 2)
# Residuals vs Fitted plots for all models
par(mfrow = c(2, 2))
plot(fitted(model_auc), residuals(model_auc),
main = "Residuals vs Fitted: AUC",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
plot(fitted(model_endpoint), residuals(model_endpoint),
main = "Residuals vs Fitted: Endpoint",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
plot(fitted(model_ancova), residuals(model_ancova),
main = "Residuals vs Fitted: Endpoint (ANCOVA)",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
plot(fitted(model_increment), residuals(model_increment),
main = "Residuals vs Fitted: Increment",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
par(mfrow = c(1, 1))
library(ggplot2)
library(gridExtra)
# Define the outcome variable
outcome <- "bprs"
# Compute summary statistics: AUC, endpoint, increment
summary_stats <- alz_long %>%
group_by(patid) %>%
summarise(
trial = first(trial),
sex = first(sex),
age = first(age),
edu = first(edu),
bmi = first(bmi),
inkomen = first(inkomen),
job = first(job),
adl = first(adl),
wzc = first(wzc),
abpet_base = first(abpet_base),
taupet_base = first(taupet_base),
cdrsb_base = first(cdrsb_base),
# Baseline Value
y0 = first(.data[[outcome]]),
# Last Available Measurement
yini = last(na.omit(.data[[outcome]])),
# Last Time Point Observed
tmax = last(na.omit(year)),
# Increment
increment = yini - y0,
# Area Under the Curve (AUC) using trapezoidal rule
AUC = sum(diff(year) * (head(.data[[outcome]], -1) + tail(.data[[outcome]], -1)) / 2, na.rm = TRUE)
)
summary(summary_stats)
#AUC: Area Under the Curve
model_auc <- lm(AUC ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_auc)
cat("The most significant ones are: sex, edu, inkomen, job, adl, wzc, abpet_base and taupet_base (***)")
#Endpoints
model_endpoint <- lm(yini ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_endpoint)
cat("The most significant ones are: age, HigherEdu, inkomen, job, adl, wzc, abpet and cdrsb(***)")
#Endpoints (Depending also on the bprs baseline) Linear Regression including bprs as a predictor
model_ancova <- lm(yini ~ y0 + trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_ancova)
cat("The most significant ones are: inkomen, job, adl, wzc, abpet, cdrsb_base(***)")
#Increment
model_increment <- lm(increment ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_increment)
library(ggplot2)
library(gridExtra)
# Define the outcome variable
outcome <- "bprs"
# Compute summary statistics: AUC, endpoint, increment
summary_stats <- alz_long %>%
group_by(patid) %>%
summarise(
trial = first(trial),
sex = first(sex),
age = first(age),
edu = first(edu),
bmi = first(bmi),
inkomen = first(inkomen),
job = first(job),
adl = first(adl),
wzc = first(wzc),
abpet_base = first(abpet_base),
taupet_base = first(taupet_base),
cdrsb_base = first(cdrsb_base),
# Baseline Value
y0 = first(.data[[outcome]]),
# Last Available Measurement
yini = last(na.omit(.data[[outcome]])),
# Last Time Point Observed
tmax = last(na.omit(year)),
# Increment
increment = yini - y0,
# Area Under the Curve (AUC) using trapezoidal rule
AUC = sum(diff(year) * (head(.data[[outcome]], -1) + tail(.data[[outcome]], -1)) / 2, na.rm = TRUE)
)
summary(summary_stats)
#AUC: Area Under the Curve
model_auc <- lm(AUC ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_auc)
cat("The most significant ones are: sex, edu, inkomen, job, adl, wzc, abpet_base and taupet_base (***)")
#Endpoints
model_endpoint <- lm(yini ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_endpoint)
cat("The most significant ones are: age, HigherEdu, inkomen, job, adl, wzc, abpet_base and cdrsb_base(***)")
#Endpoints (Depending also on the bprs baseline) Linear Regression including bprs as a predictor
model_ancova <- lm(yini ~ y0 + trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_ancova)
cat("The most significant ones are: inkomen, job, adl, wzc, abpet_base and cdrsb_base(***) [y0 highly significant (**)]")
#Increment
model_increment <- lm(increment ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_increment)
cat("The most significant ones are: inkomen, job, adl, wzc, abpet_base and cdrsb_base(***)")
AIC(model_auc, model_endpoint, model_increment, model_ancova)
BIC(model_auc, model_endpoint, model_increment, model_ancova)
# Create predicted vs observed plots for all models
p1 <- ggplot(summary_stats, aes(x = AUC, y = fitted(model_auc))) +
geom_point(alpha = 0.6) +
geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
labs(title = "Predicted vs Observed: AUC",
x = "Observed AUC",
y = "Predicted AUC") +
theme_minimal()
p2 <- ggplot(summary_stats, aes(x = yini, y = fitted(model_endpoint))) +
geom_point(alpha = 0.6) +
geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
labs(title = "Predicted vs Observed: Endpoint",
x = "Observed Endpoint",
y = "Predicted Endpoint") +
theme_minimal()
p3 <- ggplot(summary_stats, aes(x = yini, y = fitted(model_ancova))) +
geom_point(alpha = 0.6) +
geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
labs(title = "Predicted vs Observed: Endpoint (ANCOVA)",
x = "Observed Endpoint",
y = "Predicted Endpoint") +
theme_minimal()
p4 <- ggplot(summary_stats, aes(x = increment, y = fitted(model_increment))) +
geom_point(alpha = 0.6) +
geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
labs(title = "Predicted vs Observed: Increment",
x = "Observed Increment",
y = "Predicted Increment") +
theme_minimal()
grid.arrange(p1, p2, p3, p4, ncol = 2)
# Residuals vs Fitted plots for all models
par(mfrow = c(2, 2))
plot(fitted(model_auc), residuals(model_auc),
main = "Residuals vs Fitted: AUC",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
plot(fitted(model_endpoint), residuals(model_endpoint),
main = "Residuals vs Fitted: Endpoint",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
plot(fitted(model_ancova), residuals(model_ancova),
main = "Residuals vs Fitted: Endpoint (ANCOVA)",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
plot(fitted(model_increment), residuals(model_increment),
main = "Residuals vs Fitted: Increment",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
grid.arrange(p1, p2, p3, p4, ncol = 2)
AIC(model_auc, model_endpoint, model_increment, model_ancova)
BIC(model_auc, model_endpoint, model_increment, model_ancova)
