summary(stage2_slope_model)
summary(stage2_slope_model)
summary(stage2_intercept_model)
summary(stage2_slope_model)
# Stage 2 GLS model with correlation between intercept and slope
stage2_gls_model <- gls(
beta ~ param + trial + sex + age + edu + bmi + inkomen + job + adl + wzc +
abpet_base + taupet_base + cdrsb_base,
data = stage2_data,
correlation = corSymm(form = ~ 1 | patid),   # correlation structure per patient
weights = varIdent(form = ~ 1 | param),     # allow different variances for intercept/slope
method = "ML",
na.action = na.exclude
)
summary(stage2_gls_model)
View(stage2_gls_model)
# Plot Stage 1 fits with slope coloring
ggplot(alz_long, aes(x = year, y = bprs, group = patid)) +
geom_point(alpha = 0.5) +
geom_line(data = subject_data %>%
rowwise() %>%
mutate(years = list(0:4),
bprs_pred = `(Intercept)` + year * years) %>%
unnest(cols = c(years)) %>%
mutate(slope_category = ifelse(year > 0, year, NA)),  # just to attach slope info
aes(x = years, y = bprs_pred, group = patid, color = slope_category),
alpha = 0.7) +
scale_color_gradient2(low = "blue", mid = "red", high = "darkred", midpoint = 0,
name = "Slope") +
labs(title = "Stage 1: Subject-specific linear regressions for BPRS") +
theme_minimal()
# Optional: Plot Stage 1 fits for visualization
ggplot(alz_long, aes(x = year, y = bprs, group = patid)) +
geom_point(alpha = 0.5) +
geom_line(data = subject_data %>%
rowwise() %>%
mutate(years = list(0:6)) %>%
unnest(cols = c(years)) %>%
mutate(bprs_pred = `(Intercept)` + year * years),
aes(x = years, y = bprs_pred, group = patid),
color = "red", alpha = 0.5) +
labs(title = "Stage 1: Subject-specific linear regressions for BPRS") +
theme_minimal()
# Prepare predicted values for plotting
pred_data <- subject_data %>%
rowwise() %>%
mutate(years = list(0:6)) %>%
unnest(cols = c(years)) %>%
mutate(bprs_pred = `(Intercept)` + year * years)
# Calculate average trajectory
avg_trajectory <- pred_data %>%
group_by(years) %>%
summarize(avg_bprs = mean(bprs_pred))
# Improved plot
ggplot() +
# Individual trajectories
geom_line(data = pred_data,
aes(x = years, y = bprs_pred, group = patid),
color = "red", alpha = 0.2) +
# Individual points
geom_point(data = alz_long, aes(x = year, y = bprs), alpha = 0.5) +
# Average trajectory
geom_line(data = avg_trajectory,
aes(x = years, y = avg_bprs),
color = "blue", size = 1.2) +
labs(title = "Stage 1: Subject-specific linear regressions for BPRS",
subtitle = "Red = individual fits, Blue = average trajectory",
x = "Year", y = "BPRS") +
theme_minimal()
# Plot Stage the Predictions!
ggplot(alz_long, aes(x = year, y = bprs, group = patid)) +
geom_point(alpha = 0.5) +
geom_line(data = subject_data %>%
rowwise() %>%
mutate(years = list(0:6)) %>%
unnest(cols = c(years)) %>%
mutate(bprs_pred = `(Intercept)` + year * years), # Calculates the Prediction!!!
aes(x = years, y = bprs_pred, group = patid),
color = "red", alpha = 0.5) +
labs(title = "Stage 1: Subject-specific linear regressions for BPRS") +
theme_minimal()
View(alz)
# Load packages
library(nlme)
library(dplyr)
library(tidyr)
library(ggplot2)
# Model formula: BPRS depends on time (year) + baseline covariates
# Random effects: intercept + slope per patient
lme_model <- lme(
bprs ~ (trial + sex + age + edu + bmi + inkomen + job + adl + wzc + cdrsb_base + abpet_base + taupet_base) * year,
random = ~ year | patid,   # random intercept and slope
correlation = corAR1(form = ~ year | patid), # optional: AR(1) serial correlation
data = alz_long,
method = "REML",
na.action = na.exclude
)
summary(lme_model)
# GLS model from your code
gls_model <- gls(
bprs ~ sex + age + edu + bmi + job + adl + wzc + cdrsb_base + abpet_base + taupet_base + year,
correlation = corAR1(form = ~ year | patid),
weights = varIdent(form = ~ 1 | year),
data = alz_long,
method = "ML",
na.action = na.exclude
)
# Compare AIC/BIC
AIC(lme_model, gls_model)
BIC(lme_model, gls_model)
ranef_df <- ranef(lme_model) %>%
tibble::rownames_to_column("patid") %>%
rename(random_intercept = `(Intercept)`, random_slope = year)
head(ranef_df)
# Stage 1: fit per-patient linear regression
stage1_models <- alz_long %>%
group_by(patid) %>%
group_map(~ lm(bprs ~ year, data = .x), .keep = TRUE)
# Extract coefficients
stage1_coefs <- purrr::map_dfr(stage1_models, coef) %>%
mutate(patid = alz_long %>% group_by(patid) %>% group_keys() %>% pull(patid))
# Merge with random-effects estimates
comparison <- stage1_coefs %>%
left_join(ranef_df, by = "patid")
head(comparison)
alz_pred <- alz_long %>%
left_join(ranef_df, by = "patid") %>%
mutate(
bprs_pred = fixed.effects(lme_model)[1] + random_intercept +
(fixed.effects(lme_model)[2] + random_slope) * year
)
ggplot(alz_pred, aes(x = year, y = bprs, group = patid)) +
geom_point(alpha = 0.5) +
geom_line(aes(y = bprs_pred), color = "red", alpha = 0.5) +
labs(title = "Random-effects model: subject-specific predictions",
x = "Year", y = "BPRS") +
theme_minimal()
#Extract intercepts and slopes
ranef_df <- ranef(lme_model) %>%
tibble::rownames_to_column("patid") %>%
rename(random_intercept = `(Intercept)`, random_slope = year)
head(ranef_df)
alz_pred <- alz_long %>%
left_join(ranef_df, by = "patid") %>%
mutate(
bprs_pred = fixed.effects(lme_model)[1] + random_intercept +
(fixed.effects(lme_model)[2] + random_slope) * year
)
#Extract intercepts and slopes from each patient
ranef_df <- ranef(lme_model) %>%
tibble::rownames_to_column("patid") %>%
rename(random_intercept = `(Intercept)`, random_slope = year) %>%
mutate(patid = as.numeric(patid))
head(ranef_df)
alz_pred <- alz_long %>%
left_join(ranef_df, by = "patid") %>%
mutate(
bprs_pred = fixed.effects(lme_model)[1] + random_intercept +
(fixed.effects(lme_model)[2] + random_slope) * year
)
ggplot(alz_pred, aes(x = year, y = bprs, group = patid)) +
geom_point(alpha = 0.5) +
geom_line(aes(y = bprs_pred), color = "red", alpha = 0.5) +
labs(title = "Random-effects model: subject-specific predictions",
x = "Year", y = "BPRS") +
theme_minimal()
# Load packages
library(nlme)
library(dplyr)
library(ggplot2)
library(tibble)
lme_model <- lme(
bprs ~ (trial + sex + age + edu + bmi + inkomen + job + adl + wzc + cdrsb_base + abpet_base + taupet_base) * year,
random = ~ year | patid,                       # random intercept + slope per patient
correlation = corAR1(form = ~ year | patid),   # optional AR(1) serial correlation
data = alz_long,
method = "REML",
na.action = na.exclude
)
lme_model <- lme(
bprs ~ (trial + sex + age + edu + bmi + inkomen + job + adl + wzc + cdrsb_base + abpet_base + taupet_base) * year,
random = ~ year | patid,                       # random intercept + slope per patient
correlation = corAR1(form = ~ year | patid),   # optional AR(1) serial correlation
data = alz_long,
method = "REML",
na.action = na.exclude
)
# View summary
summary(lme_model)
ranef_df <- ranef(lme_model) %>%
rownames_to_column("patid") %>%
rename(random_intercept = `(Intercept)`, random_slope = year) %>%
mutate(patid = as.numeric(patid))
head(ranef_df)
alz_pred <- alz_long %>%
mutate(
bprs_pred = predict(lme_model, level = 1),   # includes random effects
bprs_pred_fixed = predict(lme_model, level = 0) # population-level (fixed effects only)
)
# Plot subject-specific predictions
ggplot(alz_pred, aes(x = year, y = bprs, group = patid)) +
geom_point(alpha = 0.5) +
geom_line(aes(y = bprs_pred), color = "red", alpha = 0.7) +
geom_line(aes(y = bprs_pred_fixed), color = "blue", linetype = "dashed", alpha = 0.7) +
labs(
title = "Mixed-effects model: observed vs predicted",
subtitle = "Red = subject-specific (with random effects), Blue = population-level (fixed effects)",
x = "Year",
y = "BPRS"
) +
theme_minimal(base_size = 13)
# Random intercepts and slopes
ggplot(ranef_df, aes(x = random_intercept)) +
geom_histogram(bins = 20, fill = "steelblue", color = "black", alpha = 0.7) +
labs(title = "Random Intercepts Distribution", x = "Intercept", y = "Count") +
theme_minimal()
ggplot(ranef_df, aes(x = random_slope)) +
geom_histogram(bins = 20, fill = "tomato", color = "black", alpha = 0.7) +
labs(title = "Random Slopes Distribution", x = "Slope (Year)", y = "Count") +
theme_minimal()
# Intercept vs Slope scatter
ggplot(ranef_df, aes(x = random_intercept, y = random_slope)) +
geom_point(alpha = 0.6) +
geom_smooth(method = "lm", se = FALSE, color = "darkgreen") +
labs(title = "Random Intercept vs Slope", x = "Intercept", y = "Slope") +
theme_minimal()
# Load packages
library(nlme)
library(dplyr)
library(ggplot2)
library(tibble)
# Fit mixed-effects model
lme_model <- lme(
bprs ~ (trial + sex + age + edu + bmi + inkomen + job + adl + wzc +
cdrsb_base + abpet_base + taupet_base) * year,
random = ~ year | patid,               # random intercept + slope per patient
correlation = corAR1(form = ~ year | patid),  # optional: AR(1) correlation
data = alz_long,
method = "REML",
na.action = na.exclude
)
summary(lme_model)
#--------------------------------
# Extract random effects
#--------------------------------
ranef_df <- ranef(lme_model) %>%
rownames_to_column("patid") %>%
rename(random_intercept = `(Intercept)`, random_slope = year) %>%
mutate(patid = as.numeric(patid))
#--------------------------------
# Create predicted values
#--------------------------------
# Fixed effects only (population-level)
fixed_effects <- fixef(lme_model)
alz_pred <- alz_long %>%
left_join(ranef_df, by = "patid") %>%
mutate(
bprs_pred = fixed_effects[1] + random_intercept +
(fixed_effects[2] + random_slope) * year,
bprs_pred_fixed = fixed_effects[1] + fixed_effects[2] * year  # population-level
)
#--------------------------------
# 1. Plot a sample of subjects
#--------------------------------
set.seed(123)
sample_patients <- sample(unique(alz_pred$patid), 10)
ggplot(alz_pred %>% filter(patid %in% sample_patients),
aes(x = year, y = bprs, group = patid, color = as.factor(patid))) +
geom_point(alpha = 0.7) +
geom_line(aes(y = bprs_pred), size = 1) +
geom_line(aes(y = bprs_pred_fixed), linetype = "dashed", color = "black", size = 0.8) +
labs(title = "Mixed-effects model trajectories (sample of 10 subjects)",
subtitle = "Colored = subject-specific; Black dashed = population-level",
x = "Year", y = "BPRS", color = "Patient ID") +
theme_minimal(base_size = 13)
# Plot subject-specific predictions
ggplot(alz_pred, aes(x = year, y = bprs, group = patid)) +
geom_point(alpha = 0.5) +
geom_line(aes(y = bprs_pred), color = "red", alpha = 0.7) +
geom_line(aes(y = bprs_pred_fixed), color = "blue", linetype = "dashed", alpha = 0.7) +
labs(
title = "Mixed-effects model: observed vs predicted",
subtitle = "Red = subject-specific (with random effects), Blue = population-level (fixed effects)",
x = "Year",
y = "BPRS"
) +
theme_minimal(base_size = 13)
# Load packages
library(nlme)
library(dplyr)
library(ggplot2)
library(tibble)
lme_model <- lme(
bprs ~ (trial + sex + age + edu + bmi + inkomen + job + adl + wzc + cdrsb_base + abpet_base + taupet_base) * year,
random = ~ year | patid,                       # random intercept + slope per patient
correlation = corAR1(form = ~ year | patid),   # optional AR(1) serial correlation
data = alz_long,
method = "REML",
na.action = na.exclude
)
# View summary
summary(lme_model)
ranef_df <- ranef(lme_model) %>%
rownames_to_column("patid") %>%
rename(random_intercept = `(Intercept)`, random_slope = year) %>%
mutate(patid = as.numeric(patid))
head(ranef_df)
alz_pred <- alz_long %>%
mutate(
bprs_pred = predict(lme_model, level = 1),   # includes random effects
bprs_pred_fixed = predict(lme_model, level = 0) # population-level (fixed effects only)
)
# Plot subject-specific predictions
ggplot(alz_pred, aes(x = year, y = bprs, group = patid)) +
geom_point(alpha = 0.5) +
geom_line(aes(y = bprs_pred), color = "red", alpha = 0.7) +
geom_line(aes(y = bprs_pred_fixed), color = "blue", linetype = "dashed", alpha = 0.7) +
labs(
title = "Mixed-effects model: observed vs predicted",
subtitle = "Red = subject-specific (with random effects), Blue = population-level (fixed effects)",
x = "Year",
y = "BPRS"
) +
theme_minimal(base_size = 13)
# Random intercepts and slopes
ggplot(ranef_df, aes(x = random_intercept)) +
geom_histogram(bins = 20, fill = "steelblue", color = "black", alpha = 0.7) +
labs(title = "Random Intercepts Distribution", x = "Intercept", y = "Count") +
theme_minimal()
ggplot(ranef_df, aes(x = random_slope)) +
geom_histogram(bins = 20, fill = "tomato", color = "black", alpha = 0.7) +
labs(title = "Random Slopes Distribution", x = "Slope (Year)", y = "Count") +
theme_minimal()
# Intercept vs Slope scatter
ggplot(ranef_df, aes(x = random_intercept, y = random_slope)) +
geom_point(alpha = 0.6) +
geom_smooth(method = "lm", se = FALSE, color = "darkgreen") +
labs(title = "Random Intercept vs Slope", x = "Intercept", y = "Slope") +
theme_minimal()
# Plot subject-specific predictions
# Sample 10 patients to reduce clutter
set.seed(123)
sample_patients <- sample(unique(alz_pred$patid), 10)
ggplot(alz_pred %>% filter(patid %in% sample_patients),
aes(x = year, y = bprs, group = patid, color = as.factor(patid))) +
geom_point(alpha = 0.7, size = 2) +
geom_line(aes(y = bprs_pred), size = 1) +        # subject-specific predictions
geom_line(aes(y = bprs_pred_fixed), color = "blue", linetype = "dashed", size = 1) +  # population
labs(
title = "Mixed-effects model: observed vs predicted",
subtitle = "Red = subject-specific (random effects), Blue dashed = population-level (fixed effects)",
x = "Year",
y = "BPRS",
color = "Patient ID"
) +
theme_minimal(base_size = 13) +
theme(legend.position = "right")
# Load packages
library(nlme)
library(dplyr)
library(ggplot2)
library(tibble)
lme_model <- lme(
bprs ~ (trial + sex + age + edu + bmi + inkomen + job + adl + wzc + cdrsb_base + abpet_base + taupet_base) * year,
random = ~ year | patid,                       # random intercept + slope per patient
correlation = corAR1(form = ~ year | patid),   # optional AR(1) serial correlation
data = alz_long,
method = "REML",
na.action = na.exclude
)
# View summary
summary(lme_model)
ranef_df <- ranef(lme_model) %>%
rownames_to_column("patid") %>%
rename(random_intercept = `(Intercept)`, random_slope = year) %>%
mutate(patid = as.numeric(patid))
head(ranef_df)
alz_pred <- alz_long %>%
mutate(
bprs_pred = predict(lme_model, level = 1),   # includes random effects
bprs_pred_fixed = predict(lme_model, level = 0) # population-level (fixed effects only)
)
# Plot subject-specific predictions
ggplot(alz_pred, aes(x = year, y = bprs, group = patid)) +
geom_point(alpha = 0.5) +
geom_line(aes(y = bprs_pred), color = "red", alpha = 0.7) +
geom_line(aes(y = bprs_pred_fixed), color = "blue", linetype = "dashed", alpha = 0.7) +
labs(
title = "Mixed-effects model: observed vs predicted",
subtitle = "Red = subject-specific (with random effects), Blue = population-level (fixed effects)",
x = "Year",
y = "BPRS"
) +
theme_minimal(base_size = 13)
# Sample 10 patients to reduce clutter
set.seed(123)
sample_patients <- sample(unique(alz_pred$patid), 10)
ggplot(alz_pred %>% filter(patid %in% sample_patients),
aes(x = year, y = bprs, group = patid, color = as.factor(patid))) +
geom_point(alpha = 0.7, size = 2) +
geom_line(aes(y = bprs_pred), size = 1) +        # subject-specific predictions
geom_line(aes(y = bprs_pred_fixed), color = "blue", linetype = "dashed", size = 1) +  # population
labs(
title = "Mixed-effects model: observed vs predicted",
subtitle = "Red = subject-specific (random effects), Blue dashed = population-level (fixed effects)",
x = "Year",
y = "BPRS",
color = "Patient ID"
) +
theme_minimal(base_size = 13) +
theme(legend.position = "right")
sample_patients <- sample(unique(alz_pred$patid), 20)
sample_patients <- sample(unique(alz_pred$patid), 20)
ggplot(alz_pred %>% filter(patid %in% sample_patients),
aes(x = year, y = bprs, group = patid, color = as.factor(patid))) +
geom_point(alpha = 0.7, size = 2) +
geom_line(aes(y = bprs_pred), size = 1) +        # subject-specific predictions
geom_line(aes(y = bprs_pred_fixed), color = "blue", linetype = "dashed", size = 1) +  # population
labs(
title = "Mixed-effects model: observed vs predicted",
subtitle = "Red = subject-specific (random effects), Blue dashed = population-level (fixed effects)",
x = "Year",
y = "BPRS",
color = "Patient ID"
) +
theme_minimal(base_size = 13) +
theme(legend.position = "right")
sample_patients <- sample(unique(alz_pred$patid), 15)
ggplot(alz_pred %>% filter(patid %in% sample_patients),
aes(x = year, y = bprs, group = patid, color = as.factor(patid))) +
geom_point(alpha = 0.7, size = 2) +
geom_line(aes(y = bprs_pred), size = 1) +        # subject-specific predictions
geom_line(aes(y = bprs_pred_fixed), color = "blue", linetype = "dashed", size = 1) +  # population
labs(
title = "Mixed-effects model: observed vs predicted",
subtitle = "Red = subject-specific (random effects), Blue dashed = population-level (fixed effects)",
x = "Year",
y = "BPRS",
color = "Patient ID"
) +
theme_minimal(base_size = 13) +
theme(legend.position = "right")
ggplot(alz_pred %>% filter(patid %in% sample_patients),
aes(x = year, y = bprs, group = patid, color = as.factor(patid))) +
geom_point(alpha = 0.7, size = 2) +
geom_line(aes(y = bprs_pred), size = 1) +        # subject-specific predictions
geom_line(aes(y = bprs_pred_fixed), color = "blue", linetype = "dashed", size = 1) +  # population
labs(
title = "Mixed-effects model: observed vs predicted",
subtitle = "Red = subject-specific (random effects), Blue dashed = population-level (fixed effects)",
x = "Year",
y = "BPRS",
color = "Patient ID"
) +
theme_minimal(base_size = 13) +
theme(legend.position = "right")
# Sample 10 patients to reduce clutter
# Sample 10 patients to reduce clutter
set.seed(123)
sample_patients <- sample(unique(alz_pred$patid), 10)
ggplot(alz_pred %>% filter(patid %in% sample_patients),
aes(x = year, y = bprs, group = patid)) +
geom_point(aes(color = as.factor(patid)), alpha = 0.7, size = 2) +   # points colored by patient
geom_line(aes(y = bprs_pred), color = "red", size = 1) +              # subject-specific predictions in red
geom_line(aes(y = bprs_pred_fixed), color = "blue", linetype = "dashed", size = 1) +  # population-level
labs(
title = "Mixed-effects model: observed vs predicted",
subtitle = "Red = subject-specific (random effects), Blue dashed = population-level (fixed effects)",
x = "Year",
y = "BPRS",
color = "Patient ID"
) +
theme_minimal(base_size = 13) +
theme(legend.position = "right")
#Extract the random effects from each patient
ranef_df <- ranef(lme_model) %>%
rownames_to_column("patid") %>%
rename(random_intercept = `(Intercept)`, random_slope = year) %>%
mutate(patid = as.numeric(patid))
head(ranef_df)
View(alz_long)
# Random intercepts and slopes
ggplot(ranef_df, aes(x = random_intercept)) +
geom_histogram(bins = 20, fill = "steelblue", color = "black", alpha = 0.7) +
labs(title = "Random Intercepts Distribution", x = "Intercept", y = "Count") +
theme_minimal()
ggplot(ranef_df, aes(x = random_slope)) +
geom_histogram(bins = 20, fill = "tomato", color = "black", alpha = 0.7) +
labs(title = "Random Slopes Distribution", x = "Slope (Year)", y = "Count") +
theme_minimal()
# Intercept vs Slope scatter
ggplot(ranef_df, aes(x = random_intercept, y = random_slope)) +
geom_point(alpha = 0.6) +
geom_smooth(method = "lm", se = FALSE, color = "darkgreen") +
labs(title = "Random Intercept vs Slope", x = "Intercept", y = "Slope") +
theme_minimal()
# Random intercepts
# Difference between a patientâ€™s baseline value and the overall population baseline.
ggplot(ranef_df, aes(x = random_intercept)) +
geom_histogram(bins = 20, fill = "blue", color = "black", alpha = 0.7) +
labs(title = "Random Intercepts Distribution", x = "Intercept", y = "Count") +
theme_minimal()
ggplot(ranef_df, aes(x = random_slope)) +
geom_histogram(bins = 20, fill = "red", color = "black", alpha = 0.7) +
labs(title = "Random Slopes Distribution", x = "Slope (Year)", y = "Count") +
theme_minimal()
# Intercept vs Slope scatter
ggplot(ranef_df, aes(x = random_intercept, y = random_slope)) +
geom_point(alpha = 0.6) +
geom_smooth(method = "lm", se = FALSE, color = "darkgreen") +
labs(title = "Random Intercept vs Slope", x = "Intercept", y = "Slope") +
theme_minimal()
