---
title: "Project 1 LDA Prova"
author: "Daniele Capelli"
date: "2025-10-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Exploratory Data Analysis in R

Start by analyzing data...

```{r}
library(haven)
library(sas7bdat)
library(ggplot2)
library(tidyr)
library(dplyr)
library(GGally)
alz <- read_sas("C:/Users/Daniele/Desktop/2025 - 26 Primo Semestre/Longitudinal Data Analysis/Project 1 Alzheimer LDA/alzheimer25.sas7bdat")
#alz <- read.csv("C:/Users/Daniele/Desktop/2025 - 26 Primo Semestre/Longitudinal Data Analysis/Project 1 Alzheimer LDA/alzheimer25.csv")

head(alz)
boxplot(alz$cdrsb0, alz$age)
summary(alz)

alz$trial <- as.factor(alz$trial)
alz$sex <- as.factor(alz$sex)
alz$edu <- as.factor(alz$edu)
alz$job <- as.factor(alz$job)
alz$wzc <- as.factor(alz$wzc)

summary(alz)
```

Then create the longitudinal data frame.

```{r}
alz_df <- data.frame(alz)

alz_long <- alz_df %>%
  pivot_longer(
    # 1️⃣ Seleziona tutte le colonne che iniziano con cdrsb, abpet o taupet,
    #     seguite da un numero (0–6)
    cols = matches("^(cdrsb|abpet|taupet)\\d+$"),
    
    # 2️⃣ Crea due nuove colonne:
    #     - ".value" → il prefisso (cdrsb, abpet, taupet)
    #     - "year"   → il numero alla fine
    names_to = c(".value", "year"),
    
    # 3️⃣ Divide i nomi in due parti: (prefisso, numero)
    names_pattern = "(cdrsb|abpet|taupet)(\\d+)"
  ) %>%
  mutate(
    year = as.numeric(year),                            # converte in numerico
    sample = factor(rep(1:nrow(alz_df), each = 7)) # ID per ogni paziente
  )
```

Discretize the quantitative variables (it is useful for later on).

```{r continuous vars bins}
## Maybe any 5 years?
alz_long$age_disc <- (alz_long$age %/% 5) * 5
alz_long$age_disc <- as.factor(alz_long$age_disc)

## bmi any 4
alz_long$bmi_disc <- (alz_long$bmi %/% 4) * 4
alz_long$bmi_disc <- as.factor(alz_long$bmi_disc)

## inkomen any 500
alz_long$inkomen_disc <- (alz_long$inkomen %/% 500) * 500
alz_long$inkomen_disc <- as.factor(alz_long$inkomen_disc)

## adl any 5
alz_long$adl_disc <- (alz_long$adl %/% 5) * 5
alz_long$adl_disc <- as.factor(alz_long$adl_disc)

## abpet any 0.2
alz_long$abpet_disc <- (alz_long$abpet %/% 0.2) * 0.2
alz_long$abpet_disc <- as.factor(alz_long$abpet_disc)

## taupet any 0.2
alz_long$taupet_disc <- (alz_long$taupet %/% 0.2) * 0.2
alz_long$taupet_disc <- as.factor(alz_long$taupet_disc)
```

Now create a restricted version to work on for simplicity in certain cases (it is too long to compute everything I will fix it later on if we need it).

```{r}
casual <- sample(1:length(alz$patid), 50)

## Now we can start by looking at random values for the mean and see
## if we can work on the mean and so on

alz_rist <- alz[casual, ]
alz_rist_df <- data.frame(alz_rist)

alz_rist_long <- alz_rist_df %>%
  pivot_longer(
    # 1️⃣ Seleziona tutte le colonne che iniziano con cdrsb, abpet o taupet,
    #     seguite da un numero (0–6)
    cols = matches("^(cdrsb|abpet|taupet)\\d+$"),
    
    # 2️⃣ Crea due nuove colonne:
    #     - ".value" → il prefisso (cdrsb, abpet, taupet)
    #     - "year"   → il numero alla fine
    names_to = c(".value", "year"),
    
    # 3️⃣ Divide i nomi in due parti: (prefisso, numero)
    names_pattern = "(cdrsb|abpet|taupet)(\\d+)"
  ) %>%
  mutate(
    year = as.numeric(year),                            # converte in numerico
    sample = factor(rep(1:nrow(alz_rist_df), each = 7)) # ID per ogni paziente
  )
```

Finally start to look at visual representations.

```{r}
ggplot(alz_rist_long, aes(x = year, y = cdrsb, group = patid, 
                                color = sample, show.legend = FALSE)) + 
  geom_line(alpha = 0.5, show.legend = FALSE) +
  theme_bw() +
  labs(title = "CDRSB against year of measuring")


ggplot(alz_rist_long, aes(x = year, y = abpet, group = patid, 
                                color = sample, show.legend = FALSE)) + 
  geom_line(alpha = 0.5, show.legend = FALSE) +
  theme_bw() +
  labs(title = "ABPET against year of measuring")

ggplot(alz_rist_long, aes(x = year, y = taupet, group = patid, 
                          color = sample, show.legend = FALSE)) + 
  geom_line(alpha = 0.5, show.legend = FALSE) +
  theme_bw() +
  labs(title = "TAUPET against year of measuring")
```

Maybe we should analyze how many missing data we have??

Now try to estimate average behavior in different groups.

```{r}
## General behavior
ggplot(alz_long, aes(x = year, y = cdrsb)) +
  stat_summary(fun = mean, geom = "line", size = 1) +
  stat_summary(fun.data = mean_sdl, geom = "ribbon", fun.args = list(mult = 1),
               alpha = 0.2, fill = "lightblue") +
  theme_minimal() +
  labs(title = "General mean behavior")

ggplot(alz_long, aes(x = year, y = cdrsb, group = sex, color = sex)) +
  stat_summary(fun = mean, geom = "line", size = 1) +
  stat_summary(fun.data = mean_sdl, geom = "ribbon", fun.args = list(mult = 1),
               alpha = 0.2, fill = "lightblue") +
  theme_minimal() +
  labs(title = "General mean behavior wrt sex")

ggplot(alz_long, aes(x = year, y = cdrsb, group = trial, color = trial)) +
  stat_summary(fun = mean, geom = "line", size = 1) +
  stat_summary(fun.data = mean_sdl, geom = "ribbon", fun.args = list(mult = 1),
               alpha = 0.2, fill = "lightblue") +
  theme_minimal() +
  labs(title = "General mean behavior wrt trial")

ggplot(alz_long, aes(x = year, y = cdrsb, group = trial, color = trial)) +
  stat_summary(fun = mean, geom = "line", size = 1) +
  #stat_summary(fun.data = mean_sdl, geom = "ribbon", fun.args = list(mult = 1),
  #             alpha = 0.2, fill = "lightblue") +
  theme_minimal() +
  labs(title = "General mean behavior wrt trial without variance")

ggplot(alz_long, aes(x = year, y = cdrsb, group = age, color = age)) +
  stat_summary(fun = mean, geom = "line", size = 1) +
  stat_summary(fun.data = mean_sdl, geom = "ribbon", fun.args = list(mult = 1),
               alpha = 0.2, fill = "lightblue") +
  theme_minimal() +
  labs(title = "General mean behavior wrt age")

ggplot(alz_long, aes(x = year, y = cdrsb, group = age, color = age)) +
  stat_summary(fun = mean, geom = "line", size = 1) +
  #stat_summary(fun.data = mean_sdl, geom = "ribbon", fun.args = list(mult = 1),
  #             alpha = 0.2, fill = "lightblue") +
  theme_minimal() +
  labs(title = "General mean behavior wrt age without variance")

ggplot(alz_long, aes(x = year, y = cdrsb, group = edu, color = edu)) +
  stat_summary(fun = mean, geom = "line", size = 1) +
  stat_summary(fun.data = mean_sdl, geom = "ribbon", fun.args = list(mult = 1),
               alpha = 0.2, fill = "lightblue") +
  theme_minimal() +
  labs(title = "General mean behavior wrt edu")

ggplot(alz_long, aes(x = year, y = cdrsb, group = bmi, color = bmi)) +
  stat_summary(fun = mean, geom = "line", size = 1) +
  stat_summary(fun.data = mean_sdl, geom = "ribbon", fun.args = list(mult = 1),
               alpha = 0.2, fill = "lightblue") +
  theme_minimal() +
  labs(title = "General mean behavior wrt bmi")

ggplot(alz_long, aes(x = year, y = cdrsb, group = bmi, color = bmi)) +
  stat_summary(fun = mean, geom = "line", size = 1) +
  #stat_summary(fun.data = mean_sdl, geom = "ribbon", fun.args = list(mult = 1),
  #             alpha = 0.2, fill = "lightblue") +
  theme_minimal() +
  labs(title = "General mean behavior wrt bmi without variance")

ggplot(alz_long, aes(x = year, y = cdrsb, group = inkomen, color = inkomen)) +
  stat_summary(fun = mean, geom = "line", size = 1) +
  stat_summary(fun.data = mean_sdl, geom = "ribbon", fun.args = list(mult = 1),
               alpha = 0.2, fill = "lightblue") +
  theme_minimal() +
  labs(title = "General mean behavior wrt inkomen")

ggplot(alz_long, aes(x = year, y = cdrsb, group = inkomen, color = inkomen)) +
  stat_summary(fun = mean, geom = "line", size = 1) +
  #stat_summary(fun.data = mean_sdl, geom = "ribbon", fun.args = list(mult = 1),
  #             alpha = 0.2, fill = "lightblue") +
  theme_minimal() +
  labs(title = "General mean behavior wrt inkomen without variance")

ggplot(alz_long, aes(x = year, y = cdrsb, group = job, color = job)) +
  stat_summary(fun = mean, geom = "line", size = 1) +
  stat_summary(fun.data = mean_sdl, geom = "ribbon", fun.args = list(mult = 1),
               alpha = 0.2, fill = "lightblue") +
  theme_minimal() +
  labs(title = "General mean behavior wrt job")

ggplot(alz_long, aes(x = year, y = cdrsb, group = adl, color = adl)) +
  stat_summary(fun = mean, geom = "line", size = 1) +
  stat_summary(fun.data = mean_sdl, geom = "ribbon", fun.args = list(mult = 1),
               alpha = 0.2, fill = "lightblue") +
  theme_minimal() +
  labs(title = "General mean behavior wrt adl")

ggplot(alz_long, aes(x = year, y = cdrsb, group = wzc, color = wzc)) +
  stat_summary(fun = mean, geom = "line", size = 1) +
  stat_summary(fun.data = mean_sdl, geom = "ribbon", fun.args = list(mult = 1),
               alpha = 0.2, fill = "lightblue") +
  theme_minimal() +
  labs(title = "General mean behavior wrt wzc")

```

From the general mean behavior it seems that over the years the cdrb value increases a little bit (not much) in a linear way. In addition it seems that the estimated variance among the years is more or less constant (so we can apply the variogram procedure??).

Speaking of the categorical variables, it doesn't seem to me that there are significant differences between groups.

Maybe we should discretize the continuous variables inside bins to see if there are significant differences. Should we consider the trial??


```{r mean quant vars}
ggplot(alz_long, aes(x = year, y = cdrsb, group = age_disc, color = age_disc)) +
  stat_summary(fun = mean, geom = "line", size = 1) +
  #stat_summary(fun.data = mean_sdl, geom = "ribbon", fun.args = list(mult = 1),
  #             alpha = 0.2, fill = "lightblue") +
  theme_minimal() +
  labs(title = "General mean behavior wrt age_disc without variance")

ggplot(alz_long, aes(x = year, y = cdrsb, group = bmi_disc, color = bmi_disc)) +
  stat_summary(fun = mean, geom = "line", size = 1) +
  #stat_summary(fun.data = mean_sdl, geom = "ribbon", fun.args = list(mult = 1),
  #             alpha = 0.2, fill = "lightblue") +
  theme_minimal() +
  labs(title = "General mean behavior wrt bmi_disc without variance")

ggplot(alz_long, aes(x = year, y = cdrsb, group = inkomen_disc, color = inkomen_disc)) +
  stat_summary(fun = mean, geom = "line", size = 1) +
  #stat_summary(fun.data = mean_sdl, geom = "ribbon", fun.args = list(mult = 1),
  #             alpha = 0.2, fill = "lightblue") +
  theme_minimal() +
  labs(title = "General mean behavior wrt inkomen_disc without variance")

ggplot(alz_long, aes(x = year, y = cdrsb, group = adl_disc, color = adl_disc)) +
  stat_summary(fun = mean, geom = "line", size = 1) +
  #stat_summary(fun.data = mean_sdl, geom = "ribbon", fun.args = list(mult = 1),
  #             alpha = 0.2, fill = "lightblue") +
  theme_minimal() +
  labs(title = "General mean behavior wrt adl_disc without variance")

ggplot(alz_long, aes(x = year, y = cdrsb, group = abpet_disc, color = abpet_disc)) +
  stat_summary(fun = mean, geom = "line", size = 1) +
  #stat_summary(fun.data = mean_sdl, geom = "ribbon", fun.args = list(mult = 1),
  #             alpha = 0.2, fill = "lightblue") +
  theme_minimal() +
  labs(title = "General mean behavior wrt abpet_disc without variance")

ggplot(alz_long, aes(x = year, y = cdrsb, group = taupet_disc, color = taupet_disc)) +
  stat_summary(fun = mean, geom = "line", size = 1) +
  #stat_summary(fun.data = mean_sdl, geom = "ribbon", fun.args = list(mult = 1),
  #             alpha = 0.2, fill = "lightblue") +
  theme_minimal() +
  labs(title = "General mean behavior wrt taupet_disc without variance")
```

Here we have more interesting results, especially for the abpet and taupet values. It could be that these two variables influence the outcome of our interest.


## Visual representation of the paired data and correlations

Just to speed up the computations it is better to use the restricted dataset.

```{r ggpairs}
ggpairs(alz_rist_long, columns = c(3:10, 19:21))
```

Speaking of cdrsb (which we are interested in), it seems that there is not particular correlation with any of the variables. However, between the categorical vars it seems that edu and wzc could have some influence. Between the numerical variables maybe bmi and adl have an higher correlation coefficient (but still not that high). Finally, abpet and taupet do not present an high correlation value with crsdb but between the two taupet seems to be more influent.
It seems that cdrsb is more or less uniformly distributed.

Just to be complete.

```{r pairs}
pairs(alz_rist_long[, c(3:10, 19:21)])
```

**DA FARE: usare pacchetto corrplot**

