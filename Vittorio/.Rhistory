taupet_base = first(taupet_base),
cdrsb_base = first(cdrsb_base),
# Baseline Value
y0 = first(.data[[outcome]]),
# Last Available Measurement
yini = last(na.omit(.data[[outcome]])),
# Last Time Point Observed
tmax = last(na.omit(year)),
# Increment
increment = yini - y0,
# Area Under the Curve (AUC) using trapezoidal rule
AUC = sum(diff(year) * (head(.data[[outcome]], -1) + tail(.data[[outcome]], -1)) / 2, na.rm = TRUE)
)
#AUC: Area Under the Curve
model_auc <- lm(AUC ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_auc)
cat("The most significant ones are: sex, edu, inkomen, job, adl, wzc, abpet_base and taupet_base (***)")
#Endpoints
model_endpoint <- lm(yini ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_endpoint)
cat("The most significant ones are: age, HigherEdu, inkomen, job, adl, wzc, abpet_base and cdrsb_base(***)")
#Endpoints (Depending also on the bprs baseline) Linear Regression including bprs as a predictor
model_ancova <- lm(yini ~ y0 + trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_ancova)
cat("The most significant ones are: inkomen, job, adl, wzc, abpet_base and cdrsb_base(***) [y0 highly significant (**)]")
#Increment
model_increment <- lm(increment ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_increment)
cat("The most significant ones are: inkomen, job, adl, wzc, abpet_base and cdrsb_base(***)")
AIC(model_auc, model_endpoint, model_increment, model_ancova)
# Create predicted vs observed plots for all models
p1 <- ggplot(summary_stats, aes(x = AUC, y = fitted(model_auc))) +
geom_point(alpha = 0.6) +
geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
labs(title = "Predicted vs Observed: AUC",
x = "Observed AUC",
y = "Predicted AUC") +
theme_minimal()
p2 <- ggplot(summary_stats, aes(x = yini, y = fitted(model_endpoint))) +
geom_point(alpha = 0.6) +
geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
labs(title = "Predicted vs Observed: Endpoint",
x = "Observed Endpoint",
y = "Predicted Endpoint") +
theme_minimal()
p3 <- ggplot(summary_stats, aes(x = yini, y = fitted(model_ancova))) +
geom_point(alpha = 0.6) +
geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
labs(title = "Predicted vs Observed: Endpoint (ANCOVA)",
x = "Observed Endpoint",
y = "Predicted Endpoint") +
theme_minimal()
p4 <- ggplot(summary_stats, aes(x = increment, y = fitted(model_increment))) +
geom_point(alpha = 0.6) +
geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
labs(title = "Predicted vs Observed: Increment",
x = "Observed Increment",
y = "Predicted Increment") +
theme_minimal()
grid.arrange(p1, p2, p3, p4, ncol = 2)
plot(fitted(model_auc), residuals(model_auc),
main = "Residuals vs Fitted: AUC",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
plot(fitted(model_endpoint), residuals(model_endpoint),
main = "Residuals vs Fitted: Endpoint",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
plot(fitted(model_ancova), residuals(model_ancova),
main = "Residuals vs Fitted: Endpoint (ANCOVA)",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
plot(fitted(model_increment), residuals(model_increment),
main = "Residuals vs Fitted: Increment",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
library(ggplot2)
library(gridExtra)
# Define the outcome variable
outcome <- "bprs"
# Compute summary statistics: AUC, endpoint, increment
summary_stats <- alz_long %>%
group_by(patid) %>%
summarise(
trial = first(trial),
sex = first(sex),
age = first(age),
edu = first(edu),
bmi = first(bmi),
inkomen = first(inkomen),
job = first(job),
adl = first(adl),
wzc = first(wzc),
abpet_base = first(abpet_base),
taupet_base = first(taupet_base),
cdrsb_base = first(cdrsb_base),
# Baseline Value
y0 = first(.data[[outcome]]),
# Last Available Measurement
yini = last(na.omit(.data[[outcome]])),
# Last Time Point Observed
tmax = last(na.omit(year)),
# Increment
increment = yini - y0,
# Area Under the Curve (AUC) using trapezoidal rule
AUC = sum(diff(year) * (head(.data[[outcome]], -1) + tail(.data[[outcome]], -1)) / 2, na.rm = TRUE)
)
# Carregar paquets
library(haven)
library(dplyr)
library(tidyr)
library(ggplot2)
library(ggcorrplot)
library(nlme)
# Llegir dades
alz <- read_sas("C:/Users/win11/Documents/Guillem/Erasmus/Assignatures/Longitudinal Data Analysis/Project-1-LDA-Personal/alzheimer25.sas7bdat")
# Convertir variables qualitatives a factors
alz$trial <- factor(alz$trial)
alz$sex <- factor(alz$sex, levels = c(0, 1), labels = c("male", "female"))
alz$edu <- factor(alz$edu, levels = c(1,2,3,4),
labels = c("Primary Ed.", "Lower Secondary Ed.", "Upper Secondary Ed.", "Higher Ed."))
alz$job <- factor(alz$job, levels = c(0, 1), labels = c("No job", "Job"))
alz$wzc <- factor(alz$wzc, levels = c(0, 1), labels = c("Home", "Residence"))
alz$abpet_base <- alz$abpet0
alz$taupet_base <- alz$taupet0
alz$cdrsb_base <- alz$cdrsb0
# Transformar a long format
alz_long <- pivot_longer(
alz,
cols = matches("^(bprs|cdrsb|abpet|taupet)\\d+$"),
names_to = c(".value", "year"),
names_pattern = "(bprs|cdrsb|abpet|taupet)(\\d+)"
)
# Convertir year a numèric
alz_long$year <- as.numeric(as.character(alz_long$year))
vars_long <- c("cdrsb", "bprs", "abpet", "taupet")
for (var in vars_long) {
cat("\n==============================\n")
cat("Variable:", var, "\n")
# Mean & SD
summary_by_year <- alz_long %>%
group_by(year) %>%
summarise(
mean_val = mean(.data[[var]], na.rm = TRUE),
sd_val   = sd(.data[[var]], na.rm = TRUE)
)
# Gràfic de mitjana amb ribbon
print(
ggplot(summary_by_year, aes(x = year, y = mean_val)) +
geom_line(color = "red", size = 1.2) +
geom_ribbon(aes(ymin = mean_val - sd_val, ymax = mean_val + sd_val),
alpha = 0.2, fill = "blue") +
labs(title = paste(var, "evolution"), x = "Year", y = var) +
theme_minimal()
)
# Gràfic de SD
print(
ggplot(summary_by_year, aes(x = year, y = sd_val)) +
geom_line(color = "darkgreen", size = 1.2) +
geom_point(color = "darkgreen", size = 2) +
labs(title = paste(var, "SD evolution (variance structure)"),
x = "Year", y = paste("SD of", var)) +
theme_minimal()
)
# Correlation
wide_df <- alz_long %>%
select(patid, year, .data[[var]]) %>%
pivot_wider(names_from = year, values_from = var)
cor_mat <- cor(wide_df[,-1], use = "pairwise.complete.obs")
print(cor_mat)
print(
ggcorrplot(cor_mat,
method = "circle",
lab = TRUE,
title = paste("Correlation structure of", var, "over years"))
)
}
model_gls_1 <- gls(
bprs ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + cdrsb_base +
abpet_base + taupet_base + (trial + sex + age + edu + bmi + inkomen +
job + adl + wzc + cdrsb_base + abpet_base + taupet_base) * year,
correlation = corAR1(form = ~ year | patid),
weights = varIdent(form = ~ 1 | year),
data = alz_long,
method = "ML",
na.action = na.exclude
)
model_gls_2 <- gls(
bprs ~ trial + sex + age + edu + job + adl + wzc + cdrsb_base +
(sex + age + job + adl + wzc + cdrsb_base) * year,
correlation = corAR1(form = ~ year | patid),
weights = varIdent(form = ~ 1 | year),
data = alz_long,
method = "ML",
na.action = na.exclude
)
model_gls_3 <- gls(
bprs ~ trial + sex + age + adl + job + (wzc + cdrsb_base) * year,
correlation = corAR1(form = ~ year | patid),
weights = varIdent(form = ~ 1 | year),
data = alz_long,
method = "ML",
na.action = na.exclude
)
#Without Trial - It has larger BIC
model_gls_4 <- gls(
bprs ~ sex + age + adl + job + (wzc + cdrsb_base) * year,
correlation = corAR1(form = ~ year | patid),
weights = varIdent(form = ~ 1 | year),
data = alz_long,
method = "ML",
na.action = na.exclude
)
anova(model_gls_1, model_gls_2, model_gls_3, model_gls_4)
library(ggplot2)
library(gridExtra)
# Define the outcome variable
outcome <- "bprs"
# Compute summary statistics: AUC, endpoint, increment
summary_stats <- alz_long %>%
group_by(patid) %>%
summarise(
trial = first(trial),
sex = first(sex),
age = first(age),
edu = first(edu),
bmi = first(bmi),
inkomen = first(inkomen),
job = first(job),
adl = first(adl),
wzc = first(wzc),
abpet_base = first(abpet_base),
taupet_base = first(taupet_base),
cdrsb_base = first(cdrsb_base),
# Baseline Value
y0 = first(.data[[outcome]]),
# Last Available Measurement
yini = last(na.omit(.data[[outcome]])),
# Last Time Point Observed
tmax = last(na.omit(year)),
# Increment
increment = yini - y0,
# Area Under the Curve (AUC) using trapezoidal rule
AUC = sum(diff(year) * (head(.data[[outcome]], -1) + tail(.data[[outcome]], -1)) / 2, na.rm = TRUE)
)
summary(summary_stats)
#AUC: Area Under the Curve
model_auc <- lm(AUC ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_auc)
cat("The most significant ones are: sex, edu, inkomen, job, adl, wzc, abpet_base and taupet_base (***)")
#Endpoints
model_endpoint <- lm(yini ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_endpoint)
cat("The most significant ones are: age, HigherEdu, inkomen, job, adl, wzc, abpet_base and cdrsb_base(***)")
#Endpoints (Depending also on the bprs baseline) Linear Regression including bprs as a predictor
model_ancova <- lm(yini ~ y0 + trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_ancova)
cat("The most significant ones are: inkomen, job, adl, wzc, abpet_base and cdrsb_base(***) [y0 highly significant (**)]")
#Increment
model_increment <- lm(increment ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc + abpet_base + taupet_base + cdrsb_base,
data = summary_stats)
summary(model_increment)
cat("The most significant ones are: inkomen, job, adl, wzc, abpet_base and cdrsb_base(***)")
AIC(model_auc, model_endpoint, model_increment, model_ancova)
# Create predicted vs observed plots for all models
p1 <- ggplot(summary_stats, aes(x = AUC, y = fitted(model_auc))) +
geom_point(alpha = 0.6) +
geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
labs(title = "Predicted vs Observed: AUC",
x = "Observed AUC",
y = "Predicted AUC") +
theme_minimal()
p2 <- ggplot(summary_stats, aes(x = yini, y = fitted(model_endpoint))) +
geom_point(alpha = 0.6) +
geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
labs(title = "Predicted vs Observed: Endpoint",
x = "Observed Endpoint",
y = "Predicted Endpoint") +
theme_minimal()
p3 <- ggplot(summary_stats, aes(x = yini, y = fitted(model_ancova))) +
geom_point(alpha = 0.6) +
geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
labs(title = "Predicted vs Observed: Endpoint (ANCOVA)",
x = "Observed Endpoint",
y = "Predicted Endpoint") +
theme_minimal()
p4 <- ggplot(summary_stats, aes(x = increment, y = fitted(model_increment))) +
geom_point(alpha = 0.6) +
geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
labs(title = "Predicted vs Observed: Increment",
x = "Observed Increment",
y = "Predicted Increment") +
theme_minimal()
grid.arrange(p1, p2, p3, p4, ncol = 2)
# Residuals vs Fitted plots for all models
par(mfrow = c(2, 2))
plot(fitted(model_auc), residuals(model_auc),
main = "Residuals vs Fitted: AUC",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
plot(fitted(model_endpoint), residuals(model_endpoint),
main = "Residuals vs Fitted: Endpoint",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
plot(fitted(model_ancova), residuals(model_ancova),
main = "Residuals vs Fitted: Endpoint (ANCOVA)",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
plot(fitted(model_increment), residuals(model_increment),
main = "Residuals vs Fitted: Increment",
xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red")
summary(model_auc)
View(alz)
View(alz)
library(ggplot2)
library(gridExtra)
# Define the outcome variable
outcome <- "bprs"
alz$n_obs_data <- rowSums(!is.na(alz[, c(18:24)]))
# Compute summary statistics: AUC, endpoint, increment
summary_stats <- alz_long %>%
group_by(patid) %>%
summarise(
trial = first(trial),
sex = first(sex),
age = first(age),
edu = first(edu),
bmi = first(bmi),
inkomen = first(inkomen),
job = first(job),
adl = first(adl),
wzc = first(wzc),
abpet_base = first(abpet_base),
taupet_base = first(taupet_base),
cdrsb_base = first(cdrsb_base),
# Baseline Value
y0 = first(.data[[outcome]]),
# Last Available Measurement
yini = last(na.omit(.data[[outcome]])),
# Last Time Point Observed
tmax = last(n_obs_data),
# Increment
increment = yini - y0,
# Area Under the Curve (AUC) using trapezoidal rule
AUC = sum(diff(year) * (head(.data[[outcome]], -1) + tail(.data[[outcome]], -1)) / 2, na.rm = TRUE)
)
library(ggplot2)
library(gridExtra)
# Define the outcome variable
outcome <- "bprs"
alz_long$n_obs_data <- rowSums(!is.na(alz[, c(18:24)]))
alz$n_obs_data <- rowSums(!is.na(alz[, c(18:24)]))
# Compute summary statistics: AUC, endpoint, increment
summary_stats <- alz_long %>%
group_by(patid) %>%
summarise(
trial = first(trial),
sex = first(sex),
age = first(age),
edu = first(edu),
bmi = first(bmi),
inkomen = first(inkomen),
job = first(job),
adl = first(adl),
wzc = first(wzc),
abpet_base = first(abpet_base),
taupet_base = first(taupet_base),
cdrsb_base = first(cdrsb_base),
# Baseline Value
y0 = first(.data[[outcome]]),
# Last Available Measurement
yini = last(na.omit(.data[[outcome]])),
# Last Time Point Observed
tmax = last(n_obs_data),
# Increment
increment = yini - y0,
# Area Under the Curve (AUC) using trapezoidal rule
AUC = sum(diff(year) * (head(.data[[outcome]], -1) + tail(.data[[outcome]], -1)) / 2, na.rm = TRUE)
)
summary(model_ancova)
AIC(model_auc, model_endpoint, model_increment, model_ancova)
library(nlme)
library(dplyr)
library(ggplot2)
library(tibble)
# Fit the mixed_effects model
# Random intercept and slope per patient
lme_model <- lme(
bprs ~ (trial + sex + age + edu + bmi + inkomen + job + adl + wzc + cdrsb_base + abpet_base + taupet_base) * year,
random = ~ year | patid,                       # random intercept + slope per patient
correlation = corAR1(form = ~ year | patid),
data = alz_long,
method = "REML",
na.action = na.exclude
)
summary(lme_model)
#Extract the random effects from each patient
ranef_df <- ranef(lme_model) %>%
rownames_to_column("patid") %>%
rename(random_intercept = `(Intercept)`, random_slope = year) %>%
mutate(patid = as.numeric(patid))
head(ranef_df)
library(nlme)
library(dplyr)
library(ggplot2)
library(tibble)
# Fit the mixed_effects model
# Random intercept and slope per patient
lme_model <- lme(
bprs ~ (trial + sex + age + edu + bmi + inkomen + job + adl + wzc + cdrsb_base + abpet_base + taupet_base) * year,
random = ~ year | patid,                       # random intercept + slope per patient
correlation = corAR1(form = ~ year | patid),
data = alz_long,
method = "REML",
na.action = na.exclude
)
summary(lme_model)
# Load packages
library(dplyr)
library(tidyr)
library(ggplot2)
library(purrr)
library(nlme)
# Stage 1: Linear regressions for every subject
stage1_models <- alz_long %>%
group_by(patid) %>%
group_map(~ lm(bprs ~ year, data = .x), .keep = TRUE)
# Extract coefficients for each subject
beta_coefs <- map_dfr(stage1_models, coef) %>%
mutate(patid = alz_long %>% group_by(patid) %>% group_keys() %>% pull(patid))
head(beta_coefs)
# Merge baseline covariates
subject_data <- alz_long %>%
select(patid, trial, sex, age, edu, bmi, inkomen, job, adl, wzc, abpet_base, taupet_base, cdrsb_base) %>%
distinct() %>%
left_join(beta_coefs, by = "patid")
# Reshape data for GLS
stage2_data <- subject_data %>%
# `(Intercept)` -> Stage 1 intercept; year -> Stage 1 slope
select(patid, `(Intercept)`, year, trial, sex, age, edu, bmi, inkomen, job, adl, wzc,
abpet_base, taupet_base, cdrsb_base) %>%
pivot_longer(cols = c(`(Intercept)`, year),
names_to = "param",     #new colum with intercept and year values
values_to = "beta")     #contains the value of the coefficient
#Convertteix param en un factor, així el model sap que és una varaible categòrica
stage2_data$param <- factor(stage2_data$param)
# Stage 2 GLS model with correlation between intercept and slope
stage2_gls_model <- gls(
beta ~ param + trial + sex + age + edu + bmi + inkomen + job + adl + wzc +
abpet_base + taupet_base + cdrsb_base,
data = stage2_data,
correlation = corSymm(form = ~ 1 | patid),   # correlation structure per patient
weights = varIdent(form = ~ 1 | param),     # allow different variances for intercept/slope
method = "ML",
na.action = na.exclude
)
summary(stage2_gls_model)
cat("paramyear = -68.3 -> slope much smaller than the intercept")
cat("Correlation intercept & slope = -0.977 -> strong negative correlation: higher intercept -> lower slope")
cat("Trial effects -> mainly affect intercept")
cat("Age = 0.786 -> older patients have higher beta")
cat("JobJob = -2.44 -> employment reduces beta")
cat("WZCResidence = 0.928 -> living in a care center increases beta")
cat("cdrsb_base = -0.0199 -> higher baseline cdrsb -> faster bprs decline")
# Plot Stage the Predictions!
ggplot(alz_long, aes(x = year, y = bprs, group = patid)) +
geom_point(alpha = 0.5) +
geom_line(data = subject_data %>%
rowwise() %>%
mutate(years = list(0:6)) %>%
unnest(cols = c(years)) %>%
mutate(bprs_pred = `(Intercept)` + year * years), # Calculates the Prediction!!!
aes(x = years, y = bprs_pred, group = patid),
color = "red", alpha = 0.5) +
labs(title = "Stage 1: Subject-specific linear regressions for BPRS") +
theme_minimal()
# Fas un model lineal de bprs que depengui de l'any.
stage1_models <- alz_long %>%
group_by(patid) %>%
group_map(~ lm(bprs ~ year, data = .x), .keep = TRUE)
# Extreus els coeficients per a cada pacient
beta_coefs <- map_dfr(stage1_models, coef) %>%
mutate(patid = alz_long %>% group_by(patid) %>% group_keys() %>% pull(patid))
head(beta_coefs)
# Merge baseline covariates
subject_data <- alz_long %>%
select(patid, trial, sex, age, edu, bmi, inkomen, job, adl, wzc, abpet_base, taupet_base, cdrsb_base) %>%
distinct() %>%
left_join(beta_coefs, by = "patid")
# Intercept model
#Fas un model lineal per explicar l'intercept dels models lineals dels coeficients anteriors
stage2_intercept_model <- lm(`(Intercept)` ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc +
abpet_base + taupet_base + cdrsb_base,
data = subject_data)
summary(stage2_intercept_model)
cat("Most significant variables for the intercept: intercept, trial(most of them), age, bmi, job, wzc and cdrsb_base(**).")
# Slope model
#Fas un model lineal per explicar la slope dels models lineals dels coeficients anteriors
stage2_slope_model <- lm(year ~ trial + sex + age + edu + bmi + inkomen + job + adl + wzc +
abpet_base + taupet_base + cdrsb_base,
data = subject_data %>%
rename(year = `year`))
summary(stage2_slope_model)
cat("Most significant variables for the slope: cdrsb_base (and  with (*): age, job, adl and wzc")
